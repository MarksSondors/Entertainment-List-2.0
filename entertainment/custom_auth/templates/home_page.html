{% extends "components/base.html" %}
{% load static %}

{% block content %}
    <!-- Main content area - removing the hero section -->
    <div class="row px-2 py-2">
        <!-- Left column - Actions (keep the current style but adjust size) -->
        <div class="col-12 col-md-4 mb-3">
            <div class="window" style="width: 100%;">
                <div class="title-bar">
                    <div class="title-bar-text">Quick Actions</div>
                    <div class="title-bar-controls">
                        <button aria-label="Minimize"></button>
                        <button aria-label="Maximize"></button>
                        <button aria-label="Close"></button>
                    </div>
                </div>
                <div class="window-body">
                    <fieldset>
                        <legend>Add Content</legend>
                        <ul class="tree-view">
                            <li>
                                <a href="javascript:void(0);" onclick="openModal()" style="display: flex; align-items: center; padding: 5px 0;">
                                    <img src="https://liseklucian.neocities.org/buttons/ie_animated.gif" alt="Add Movie" style="max-width: 88px; margin-right: 10px;">
                                    <span>Add Movie</span>
                                </a>
                            <li>
                                <a href="javascript:void(0);" onclick="openTVShowModal()" style="display: flex; align-items: center; padding: 5px 0;">
                                    <img src="https://liseklucian.neocities.org/buttons/bandwith_conservation_society.gif" alt="Add TV Show" style="max-width: 88px; margin-right: 10px;">
                                    <span>Add TV Show</span>
                                </a>
                            </li>
                            <li>
                                <a href="javascript:void(0);" onclick="openBookModal()" style="display: flex; align-items: center; padding: 5px 0;">
                                    <img src="https://fustilugz.neocities.org/four/adultchat.gif" alt="Add Book" style="max-width: 88px; margin-right: 10px;">
                                    <span>Add Book</span>
                                </a>
                            </li>
                            <li>
                                <a href="javascript:void(0);" onclick="openAlbumModal()" style="display: flex; align-items: center; padding: 5px 0;">
                                    <img src="https://fustilugz.neocities.org/buttons/12/button-tupachq1.gif" alt="Add Music" style="max-width: 88px; margin-right: 10px;">
                                    <span>Add Music</span>
                                </a>
                            </li>
                        </ul>
                    </fieldset>
                    
                    <fieldset>
                        <legend>Explore</legend>
                        <ul class="tree-view">
                            <li>
                                <a href="{% url 'watchlist_page' %}" style="display: flex; align-items: center; padding: 5px 0;">
                                    <img src="https://anlucas.neocities.org/bookmark_this_page.gif" alt="View Watchlist" style="max-width: 88px; margin-right: 10px;">
                                    <span>Your Watchlist</span>
                                </a>
                            </li>
                            <li>
                                <a href="{% url 'all_movies_page' %}" style="display: flex; align-items: center; padding: 5px 0;">
                                    <img src="https://cyber.dabamos.de/88x31/88-31-banner.gif" alt="All Movies" style="max-width: 88px; margin-right: 10px;">
                                    <span>All Movies</span>
                                </a>
                            </li>
                            <li>
                                <a href="{% url 'browse_by_genre' %}" style="display: flex; align-items: center; padding: 5px 0;">
                                    <img src="https://anlucas.neocities.org/got_html.gif" alt="Browse by Genre" style="max-width: 88px; margin-right: 10px;">
                                    <span>Browse by Genre</span>
                                </a>
                            </li>
                            <li>
                                <a href="{% url 'browse_by_country' %}" style="display: flex; align-items: center; padding: 5px 0;">
                                    <img src="https://cyber.dabamos.de/88x31/88ibet.gif" alt="Your Profile" style="max-width: 88px; margin-right: 10px;">
                                    <span>Browse by Country</span>
                                </a>
                            </li>
                        </ul>
                    </fieldset>
                </div>
                <div class="status-bar">
                    <div class="status-bar-field">Select an action to continue</div>
                </div>
            </div>
            
            <!-- Recommended For You --> 
            <div class="window" style="width: 100%; margin-top: 20px;">
                <div class="title-bar">
                    <div class="title-bar-text">Recommended For You</div>
                    <div class="title-bar-controls">
                        <button aria-label="Minimize"></button>
                        <button aria-label="Maximize"></button>
                        <button aria-label="Close"></button>
                    </div>
                </div>
                <div class="window-body" style="padding: 8px; background-color: #eee;">
                    <div class="scrollable-row" id="recommended_movies_block">
                        <div class="poster-item">
                            <div class="poster-card">Loading recommendations...</div>
                        </div>
                    </div>
                </div>
                <div class="status-bar">
                    <div class="status-bar-field">Based on your ratings</div>
                </div>
            </div>
        </div>
        
        <!-- Right column - Content (made much smaller) -->
        <div class="col-12 col-md-8">
            <!-- Popular Content - Smaller size -->
            <div class="window mb-3" style="width: 100%;">
                <div class="title-bar">
                    <div class="title-bar-text">Popular Content</div>
                    <div class="title-bar-controls">
                        <button aria-label="Minimize"></button>
                        <button aria-label="Maximize"></button>
                        <button aria-label="Close"></button>
                    </div>
                </div>
                <div class="window-body" style="padding: 8px;">
                    <!-- Compact tabs -->
                    <div class="field-row mb-2">
                        <button id="tab-movies" class="tab-btn active">Movies</button>
                        <button id="tab-tvshows" class="tab-btn">TV Shows</button>
                        <button id="tab-books" class="tab-btn">Books</button>
                        <button id="tab-music" class="tab-btn">Music</button>
                    </div>
                    
                    <!-- Content panels - smaller and more compact -->
                    <div id="panel-movies" class="tab-panel">
                        <div class="scrollable-row" id="popular_movies_block">
                            <div class="poster-item">
                                <div class="poster-card">Loading...</div>
                            </div>
                        </div>
                    </div>
                    
                    <div id="panel-tvshows" class="tab-panel" style="display: none;">
                        <div class="scrollable-row" id="popular_tvshows_block">
                            <div class="poster-item">
                                <div class="poster-card">Loading...</div>
                            </div>
                        </div>
                    </div>

                    <div id="panel-books" class="tab-panel" style="display: none;">
                        <div class="scrollable-row" id="popular_books_block">
                            <div class="poster-item">
                                <div class="poster-card">Coming soon</div>
                            </div>
                        </div>
                    </div>

                    <div id="panel-music" class="tab-panel" style="display: none;">
                        <div class="scrollable-row" id="popular_music_block">
                            <div class="poster-item">
                                <div class="poster-card">Coming soon</div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="status-bar">
                    <div class="status-bar-field">Updated hourly</div>
                </div>
            </div>
            
            <!-- Recent Reviews - Also more compact -->
            <div class="window" style="width: 100%;">
                <div class="title-bar">
                    <div class="title-bar-text">Recent Community Reviews</div>
                    <div class="title-bar-controls">
                        <button aria-label="Minimize"></button>
                        <button aria-label="Maximize"></button>
                        <button aria-label="Close"></button>
                    </div>
                </div>
                <div class="window-body" style="background-color: #eee; color: #333; font-family: 'MS Sans Serif', sans-serif; padding: 8px;">
                    <div style="padding: 5px; border: 1px inset #d5d5d5;">
                        <ul id="recent_reviews" class="tree-view" style="margin: 0; padding: 0 0 0 16px;">
                            <li>> john_doe: "Amazing movie, a must-watch!" <br> Movie: Inception <br> Rating: ★★★★★</li>
                            <li>> jane_smith: "Not my cup of tea, but well-made." <br> Movie: Titanic <br> Rating: ★★★☆☆</li>
                            <li>> movie_buff99: "A cinematic masterpiece!" <br> Movie: The Godfather <br> Rating: ★★★★★</li>
                            <li>> casual_viewer: "It was okay, nothing special." <br> Movie: Avatar <br> Rating: ★★☆☆☆</li>
                            <li>> critic101: "Overhyped, but still enjoyable." <br> Movie: The Dark Knight <br> Rating: ★★★★☆</li>
                        </ul>
                    </div>
                    <div class="field-row" style="justify-content: flex-end; margin-top: 8px;">
                        <button>See All Reviews</button>
                    </div>
                </div>
                <div class="status-bar">
                    <div class="status-bar-field">Last updated: Today</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Welcome Modal (Only shown for first-time visitors) -->
    <div id="welcome-modal" class="modal" style="display: none;">
        <div class="window">
            <div class="title-bar">
                <div class="title-bar-text">Welcome to Entertainment List!</div>
                <div class="title-bar-controls">
                    <button aria-label="Close" onclick="closeWelcomeModal()"></button>
                </div>
            </div>
            <div class="window-body">
                <div class="field-row-stacked" style="text-align: center;">
                    <img src="{% static 'images/frontend-logo.png' %}" alt="Entertainment List Logo" style="width: 25%; max-width: 100px;" />
                    <h1 style="color: #5e9ca0; font-size: clamp(18px, 5vw, 24px);">
                        <span style="background-color: #ff00ff; color: #ffffff;">Welcome to <span style="color: #0000ff;">Entertainment</span> List!</span>
                    </h1>
                    <p style="color: #222; padding: 10px; font-size: 16px; max-width: 800px; margin: 0 auto;">
                        Whether the latest cinematic universe has a "definitive ranking" or not is irrelevant from our perspective. However, its evolution is joyously significant to us at Entertainment List. The joy is that our dedicated platform has made it clear to us that this moment is the "marker" we've been waiting for—the time to fully immerse ourselves in managing our favorite movies, shows, and more, all in one place.
                    </p>
                    <button onclick="closeWelcomeModal()" class="mt-3">Get Started</button>
                </div>
            </div>
            <div class="status-bar">
                <div class="status-bar-field">Click "Get Started" to continue</div>
            </div>
        </div>
    </div>

    {% include 'movie_search_modal.html' %}
    {% include 'tv_show_search_modal.html' %}
    {% include 'album_search_modal.html' %}
    
    <style>
        .tree-view li {
            margin-bottom: 8px;
            padding: 5px;
            border-bottom: 1px solid #e0e0e0;
        }
        
        .tree-view li a {
            text-decoration: none;
            color: inherit;
        }
        
        .tree-view li a:hover {
            background-color: #e0e0e0;
        }
        
        .tab-btn {
            border: 1px solid #a0a0a0;
            background-color: #d4d0c8;
            margin-right: 2px;
            padding: 2px 6px;
            cursor: pointer;
            outline: none;
        }
        
        .tab-btn.active {
            border-bottom: 1px solid #d4d0c8;
            font-weight: bold;
        }
        
        .compact-card {
            border: 1px solid #a0a0a0;
            padding: 4px;
            margin-bottom: 6px;
            font-size: 0.85rem;
            text-align: center;
            background-color: white;
        }
        
        .poster-card {
            border: 1px solid #a0a0a0;
            background-color: white;
            height: 100%;
            display: flex;
            flex-direction: column;
            position: relative;
            margin-bottom: 6px;
            overflow: hidden;
        }
        
        .poster-card img {
            width: 100%;
            height: auto;
            aspect-ratio: 2/3;
            object-fit: contain;
            object-position: center top;
        }
        
        .poster-card .info-overlay {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background-color: rgba(0,0,0,0.7);
            color: white;
            padding: 5px;
            font-size: 11px;
            text-align: center;
        }
        
        .poster-card .title {
            font-weight: bold;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            margin-bottom: 2px;
        }
        
        .poster-card .rating {
            display: inline-block;
            background-color: #ffc107;
            color: #000;
            padding: 1px 4px;
            border-radius: 3px;
            font-weight: bold;
            font-size: 10px;
        }
        
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        
        .modal .window {
            width: 90%;
            max-width: 600px;
        }
        
        .scrollable-row {
            display: flex;
            overflow-x: auto;
            scroll-behavior: smooth;
            -webkit-overflow-scrolling: touch;
            gap: 8px;
            padding: 4px;
            scrollbar-width: thin;
        }
        
        .scrollable-row::-webkit-scrollbar {
            height: 8px;
        }
        
        .scrollable-row::-webkit-scrollbar-thumb {
            background: #a0a0a0;
            border-radius: 4px;
        }
        
        .scrollable-row::-webkit-scrollbar-track {
            background: #d4d0c8;
        }
        
        .scrollable-row .poster-item {
            flex: 0 0 auto;
            width: 200px;
            margin-bottom: 8px;
        }
        
        @media (max-width: 768px) {
            .tree-view li a {
                flex-wrap: wrap;
                padding: 10px 0;
            }
            
            .tree-view li a img {
                margin-bottom: 5px;
            }
            .poster-card img {
                width: 100%;
                height: auto;
            }
        }
    </style>
    
    <script>
        // Check if first-time visitor
        document.addEventListener('DOMContentLoaded', function() {
            if (!localStorage.getItem('returningUser')) {
                // Show welcome modal for first-time visitors
                document.getElementById('welcome-modal').style.display = 'flex';
                // Set flag in localStorage
                localStorage.setItem('returningUser', 'true');
            }
            
            // Set up tab functionality
            const tabButtons = document.querySelectorAll('.tab-btn');
            tabButtons.forEach(button => {
                button.addEventListener('click', () => {
                    // Hide all panels
                    document.querySelectorAll('.tab-panel').forEach(panel => {
                        panel.style.display = 'none';
                    });
                    
                    // Remove active class from all buttons
                    tabButtons.forEach(btn => {
                        btn.classList.remove('active');
                    });
                    
                    // Show the selected panel
                    const panelId = 'panel-' + button.id.split('-')[1];
                    document.getElementById(panelId).style.display = 'block';
                    
                    // Add active class to clicked button
                    button.classList.add('active');
                });
            });
        });
        
        // Close welcome modal
        function closeWelcomeModal() {
            document.getElementById('welcome-modal').style.display = 'none';
        }
        
        // Modal functions
        function openBookModal() {
            alert("Book feature coming soon!");
            // Implement book modal when ready
        }
    
        // Fetch popular movies
        fetch('/movies/popular/')
            .then(response => response.json())
            .then(data => {
                const movieList = document.getElementById('popular_movies_block');
                movieList.innerHTML = '';
                if (data.length === 0) {
                    movieList.innerHTML = '<div class="poster-item"><div class="poster-card">No movies found</div></div>';
                    return;
                }
                data.slice(0, 10).forEach(movie => {
                    const movieItem = document.createElement('div');
                    movieItem.className = 'poster-item';
                    movieItem.innerHTML = `
                        <div class="poster-card">
                            <a href="/movies/${movie.id}" style="text-decoration:none; color:inherit; display:block; height:100%;">
                                <img src="${movie.poster_path || '{% static "images/no-poster.png" %}'}" 
                                     alt="${movie.title}">
                                <div class="info-overlay">
                                    <div class="title">${movie.title}</div>
                                    <div class="rating">${movie.vote_average}/10</div>
                                </div>
                            </a>
                        </div>
                    `;
                    movieList.appendChild(movieItem);
                });
            })
            .catch(error => {
                console.error('Error fetching popular movies:', error);
                document.getElementById('popular_movies_block').innerHTML = 
                    '<div class="poster-item"><div class="alert alert-danger">Failed to load movies</div></div>';
            });
            
        // Fetch popular TV shows
        fetch('/tvshows/popular/')
            .then(response => response.json())
            .then(data => {
                const tvList = document.getElementById('popular_tvshows_block');
                tvList.innerHTML = '';
                if (data.length === 0) {
                    tvList.innerHTML = '<div class="poster-item"><div class="poster-card">No TV shows found</div></div>';
                    return;
                }
                data.slice(0, 10).forEach(show => {
                    const showItem = document.createElement('div');
                    showItem.className = 'poster-item';
                    showItem.innerHTML = `
                        <div class="poster-card">
                            <a href="#" style="text-decoration:none; color:inherit; display:block; height:100%;">
                                <img src="${show.poster_path || '{% static "images/no-poster.png" %}'}" 
                                     alt="${show.name}">
                                <div class="info-overlay">
                                    <div class="title">${show.name}</div>
                                    <div class="rating">${show.vote_average}/10</div>
                                </div>
                            </a>
                        </div>
                    `;
                    tvList.appendChild(showItem);
                });
            })
            .catch(error => {
                console.error('Error fetching popular TV shows:', error);
                document.getElementById('popular_tvshows_block').innerHTML = 
                    '<div class="poster-item"><div class="alert alert-danger">Failed to load TV shows</div></div>';
            });
            
        // For books and music tabs - placeholder data
        document.getElementById('popular_books_block').innerHTML = 
            '<div class="poster-item" style="width: 100%;"><div class="poster-card p-2" style="justify-content: center; align-items: center; display: flex; height: 140px;">Book integration coming soon!</div></div>';
        document.getElementById('popular_music_block').innerHTML = 
            '<div class="poster-item" style="width: 100%;"><div class="poster-card p-2" style="justify-content: center; align-items: center; display: flex; height: 140px;">Music integration coming soon!</div></div>';

        // Fetch movie recommendations
        fetch('/movies/recommendations/')
            .then(response => response.json())
            .then(data => {
                const movieList = document.getElementById('recommended_movies_block');
                movieList.innerHTML = '';
                if (data.length === 0) {
                    movieList.innerHTML = '<div class="poster-item"><div class="poster-card">No recommendations yet. Rate more movies to get personalized suggestions.</div></div>';
                    return;
                }
                data.forEach(movie => {
                    const movieItem = document.createElement('div');
                    movieItem.className = 'poster-item';
                    movieItem.innerHTML = `
                        <div class="poster-card">
                            <a href="/movies/${movie.tmdb_id}" style="text-decoration:none; color:inherit; display:block; height:100%;">
                                <img src="${movie.poster || '{% static "images/no-poster.png" %}'}" 
                                     alt="${movie.title}">
                                <div class="info-overlay">
                                    <div class="title">${movie.title}</div>
                                    <div class="rating">${movie.rating}/10</div>
                                </div>
                            </a>
                        </div>
                    `;
                    movieList.appendChild(movieItem);
                });
            })
            .catch(error => {
                console.error('Error fetching recommendations:', error);
                document.getElementById('recommended_movies_block').innerHTML = 
                    '<div class="poster-item"><div class="alert alert-danger">Failed to load recommendations</div></div>';
            });
            
        // Fetch recent reviews
        fetch('/reviews/recent/')
            .then(response => response.json())
            .then(data => {
                const reviewsList = document.getElementById('recent_reviews');
                reviewsList.innerHTML = '';
                
                if (data.length === 0) {
                    reviewsList.innerHTML = '<li>No reviews yet. Be the first to share your thoughts!</li>';
                    return;
                }
                
                data.slice(0, 5).forEach(review => {
                    const reviewItem = document.createElement('li');
                    
                    // Create star rating display
                    let stars = '';
                    for (let i = 0; i < 10; i++) {
                        stars += i < Math.round(review.rating) ? '★' : '☆';
                    }
                    
                    // Determine content type label (Movie, TV Show, etc.)
                    const contentType = review.content_type || 'Movie';
                    
                    reviewItem.innerHTML = `> ${review.username}: "${review.content}" <br> ${contentType}: ${review.title} <br> Rating: ${stars}`;
                    reviewsList.appendChild(reviewItem);
                });
                
                // Update last updated time
                const now = new Date();
                document.querySelector('.window:last-child .status-bar-field').textContent = 
                    'Last updated: ' + now.toLocaleTimeString();
            })
            .catch(error => {
                console.error('Error fetching recent reviews:', error);
                document.getElementById('recent_reviews').innerHTML = 
                    '<li>Failed to load reviews. Please try again later.</li>';
            });
    </script>
{% endblock %}