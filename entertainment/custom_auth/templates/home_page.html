{% extends "components/base.html" %}
{% load static %}

{% block content %}
    <!-- Main content area - removing the hero section -->
    <div class="row px-2 py-2">
        <!-- Left column - Actions (keep the current style but adjust size) -->
        <div class="col-12 col-md-4 mb-3">
            <div class="window" style="width: 100%;">
                <div class="title-bar">
                    <div class="title-bar-text">Quick Actions</div>
                    <div class="title-bar-controls">
                        <button aria-label="Minimize"></button>
                        <button aria-label="Maximize"></button>
                        <button aria-label="Close"></button>
                    </div>
                </div>
                <div class="window-body">
                    <fieldset>
                        <legend>Add Content</legend>
                        <ul class="tree-view">
                            <li>
                                <a href="javascript:void(0);" onclick="openModal()" style="display: flex; align-items: center; padding: 5px 0;">
                                    <img src="https://liseklucian.neocities.org/buttons/ie_animated.gif" alt="Add Movie" style="max-width: 88px; margin-right: 10px;">
                                    <span>Add Movie</span>
                                </a>
                            <li>
                                <a href="javascript:void(0);" onclick="openTVShowModal()" style="display: flex; align-items: center; padding: 5px 0;">
                                    <img src="https://liseklucian.neocities.org/buttons/bandwith_conservation_society.gif" alt="Add TV Show" style="max-width: 88px; margin-right: 10px;">
                                    <span>Add TV Show</span>
                                </a>
                            </li>
                            <li>
                                <img src="https://commodorn.neocities.org/images/divs/consbar.gif" style="max-width: 100%; height: auto; display: block;">
                            </li>
                            <li>
                                <a href="javascript:void(0);" onclick="openBookModal()" style="display: flex; align-items: center; padding: 5px 0;">
                                    <img src="https://fustilugz.neocities.org/four/adultchat.gif" alt="Add Book" style="max-width: 88px; margin-right: 10px;">
                                    <span>Add Book</span>
                                </a>
                            </li>
                            <li>
                                <a href="javascript:void(0);" onclick="openAlbumModal()" style="display: flex; align-items: center; padding: 5px 0;">
                                    <img src="https://fustilugz.neocities.org/buttons/12/button-tupachq1.gif" alt="Add Music" style="max-width: 88px; margin-right: 10px;">
                                    <span>Add Music</span>
                                </a>
                            </li>
                            <li>
                                <img src="https://commodorn.neocities.org/images/divs/consbar.gif" style="max-width: 100%; height: auto; display: block;">
                            </li>
                        </ul>
                    </fieldset>
                    
                    <fieldset>
                        <legend>Explore</legend>
                        <ul class="tree-view">
                            <li>
                                <a href="{% url 'watchlist_page' %}" style="display: flex; align-items: center; padding: 5px 0;">
                                    <img src="https://anlucas.neocities.org/bookmark_this_page.gif" alt="View Watchlist" style="max-width: 88px; margin-right: 10px;">
                                    <span>Your Watchlist</span>
                                </a>
                            </li>
                            <li>
                                <a href="{% url 'random_unwatched_movie' %}" style="display: flex; align-items: center; padding: 5px 0;">
                                    <img src="https://fustilugz.neocities.org/buttons/13/antihentai.gif" alt="Random Unwatched" style="max-width: 88px; margin-right: 10px;">
                                    <span>Random Movie</span>
                                    
                                </a>
                            </li>
                            <li>
                                <a href="{% url 'shortest_watchlist_movie' %}" style="display: flex; align-items: center; padding: 5px 0;">
                                    <img src="https://fustilugz.neocities.org/buttons/new%20ones%20lol/dbfire88.gif" alt="Shortest Movie" style="max-width: 88px; margin-right: 10px;">
                                    <span>Quickest Watch</span>
                                </a>
                            </li>
                            <li>
                                <a href="{% url 'all_movies_page' %}" style="display: flex; align-items: center; padding: 5px 0;">
                                    <img src="https://cyber.dabamos.de/88x31/88-31-banner.gif" alt="All Movies" style="max-width: 88px; margin-right: 10px;">
                                    <span>All Movies</span>
                                </a>
                            </li>
                            <li>
                                <a href="{% url 'browse_by_genre' %}" style="display: flex; align-items: center; padding: 5px 0;">
                                    <img src="https://anlucas.neocities.org/got_html.gif" alt="Browse by Genre" style="max-width: 88px; margin-right: 10px;">
                                    <span>Browse by Genre</span>
                                </a>
                            </li>
                            <li>
                                <a href="{% url 'browse_by_country' %}" style="display: flex; align-items: center; padding: 5px 0;">
                                    <img src="https://cyber.dabamos.de/88x31/88ibet.gif" alt="Your Profile" style="max-width: 88px; margin-right: 10px;">
                                    <span>Browse by Country</span>
                                </a>
                            </li>
                            <li>
                                <a href="{% url 'browse_by_people' %}" style="display: flex; align-items: center; padding: 5px 0;">
                                    <img src="https://fustilugz.neocities.org/buttons/new%20ones%20lol/pyroani.gif" alt="Your Profile" style="max-width: 88px; margin-right: 10px;">
                                    <span>Browse by People</span>
                                </a>
                            </li>
                            <li>
                                <a href="{% url 'movie_statistics' %}" style="display: flex; align-items: center; padding: 5px 0;">
                                    <img src="https://fustilugz.neocities.org/buttons/12/88x31-10.gif" alt="Movie Statistics" style="max-width: 88px; margin-right: 10px;">
                                    <span>Movie Statistics</span>
                                </a>
                            </li>
                        </ul>
                    </fieldset>
                </div>
                <div class="status-bar">
                    <div class="status-bar-field">Select an action to continue</div>
                </div>
            </div>
            
            <!-- Recommended For You --> 
            <div class="window" style="width: 100%; margin-top: 20px;">
                <div class="title-bar">
                    <div class="title-bar-text">Recommended For You</div>
                    <div class="title-bar-controls">
                        <button aria-label="Minimize"></button>
                        <button aria-label="Maximize"></button>
                        <button aria-label="Close"></button>
                    </div>
                </div>
                <div class="window-body" style="padding: 8px; background-color: #eee;">
                    <div class="scrollable-row" id="recommended_movies_block">
                        <div class="poster-item">
                            <div class="poster-card">Loading recommendations...</div>
                        </div>
                    </div>
                </div>
                <div class="status-bar">
                    <div class="status-bar-field">Based on your ratings</div>
                </div>
            </div>
        </div>
        
        <!-- Right column - Content (made much smaller) -->
        <div class="col-12 col-md-8">
            <!-- Popular Content - Smaller size -->
            <div class="window mb-3" style="width: 100%;">
                <div class="title-bar">
                    <div class="title-bar-text">Popular Content</div>
                    <div class="title-bar-controls">
                        <button aria-label="Minimize"></button>
                        <button aria-label="Maximize"></button>
                        <button aria-label="Close"></button>
                    </div>
                </div>
                <div class="window-body" style="padding: 8px;">
                    <!-- Compact tabs -->
                    <div class="field-row mb-2">
                        <button id="tab-movies" class="tab-btn active">Movies</button>
                        <button id="tab-tvshows" class="tab-btn">TV Shows</button>
                        <button id="tab-books" class="tab-btn">Books</button>
                        <button id="tab-music" class="tab-btn">Music</button>
                    </div>
                    
                    <!-- Content panels - smaller and more compact -->
                    <div id="panel-movies" class="tab-panel">
                        <div class="scrollable-row" id="popular_movies_block">
                            <div class="poster-item">
                                <div class="poster-card">Loading...</div>
                            </div>
                        </div>
                    </div>
                    
                    <div id="panel-tvshows" class="tab-panel" style="display: none;">
                        <div class="scrollable-row" id="popular_tvshows_block">
                            <div class="poster-item">
                                <div class="poster-card">Loading...</div>
                            </div>
                        </div>
                    </div>

                    <div id="panel-books" class="tab-panel" style="display: none;">
                        <div class="scrollable-row" id="popular_books_block">
                            <div class="poster-item">
                                <div class="poster-card">Coming soon</div>
                            </div>
                        </div>
                    </div>

                    <div id="panel-music" class="tab-panel" style="display: none;">
                        <div class="scrollable-row" id="popular_music_block">
                            <div class="poster-item">
                                <div class="poster-card">Coming soon</div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="status-bar">
                    <div class="status-bar-field">Updated hourly</div>
                </div>
            </div>
            
            <!-- Recent Reviews - Also more compact -->
            <div class="window" style="width: 100%;">
                <div class="title-bar">
                    <div class="title-bar-text">Recent Community Activity</div>
                    <div class="title-bar-controls">
                        <button aria-label="Minimize"></button>
                        <button aria-label="Maximize"></button>
                        <button aria-label="Close"></button>
                    </div>
                </div>
                <div class="window-body" style="background-color: #eee; color: #333; font-family: 'MS Sans Serif', sans-serif; padding: 8px;">
                    <div style="padding: 5px; border: 1px inset #d5d5d5; height: 500px; overflow-y: auto;">
                        <ul id="recent_activity" class="tree-view" style="margin: 0;">
                        </ul>
                    </div>
                    <div class="field-row" style="justify-content: flex-end; margin-top: 8px;">
                        <button>See All Activity</button>
                    </div>
                </div>
                <div class="status-bar">
                    <div class="status-bar-field" id="activity-last-updated">Last updated: Just now</div>
                    <div class="status-bar-field">
                        <label><input type="checkbox" id="auto-refresh-toggle" checked> Auto-refresh</label>
                        <span id="refresh-indicator" style="display: none; margin-left: 5px;">⟳</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Welcome Modal (Only shown for first-time visitors) -->
    <div id="welcome-modal" class="modal" style="display: none;">
        <div class="window">
            <div class="title-bar">
                <div class="title-bar-text">Welcome to Entertainment List!</div>
                <div class="title-bar-controls">
                    <button aria-label="Close" onclick="closeWelcomeModal()"></button>
                </div>
            </div>
            <div class="window-body">
                <div class="field-row-stacked" style="text-align: center;">
                    <img src="{% static 'images/frontend-logo.png' %}" alt="Entertainment List Logo" style="width: 25%; max-width: 100px;" />
                    <h1 style="color: #5e9ca0; font-size: clamp(18px, 5vw, 24px);">
                        <span style="background-color: #ff00ff; color: #ffffff;">Welcome to <span style="color: #0000ff;">Entertainment</span> List!</span>
                    </h1>
                    <p style="color: #222; padding: 10px; font-size: 16px; max-width: 800px; margin: 0 auto;">
                        Whether the latest cinematic universe has a "definitive ranking" or not is irrelevant from our perspective. However, its evolution is joyously significant to us at Entertainment List. The joy is that our dedicated platform has made it clear to us that this moment is the "marker" we've been waiting for—the time to fully immerse ourselves in managing our favorite movies, shows, and more, all in one place.
                    </p>
                    <button onclick="closeWelcomeModal()" class="mt-3">Get Started</button>
                </div>
            </div>
            <div class="status-bar">
                <div class="status-bar-field">Click "Get Started" to continue</div>
            </div>
        </div>
    </div>

    {% include 'movie_search_modal.html' %}
    {% include 'tv_show_search_modal.html' %}
    {% include 'album_search_modal.html' %}
    
    <style>
        .tree-view li {
            margin-bottom: 8px;
            padding: 5px;
            border-bottom: 1px solid #e0e0e0;
        }
        
        .tree-view li a {
            text-decoration: none;
            color: inherit;
        }
        
        .tree-view li a:hover {
            background-color: #e0e0e0;
        }
        
        .tab-btn {
            border: 1px solid #a0a0a0;
            background-color: #d4d0c8;
            margin-right: 2px;
            padding: 2px 6px;
            cursor: pointer;
            outline: none;
        }
        
        .tab-btn.active {
            border-bottom: 1px solid #d4d0c8;
            font-weight: bold;
        }
        
        .compact-card {
            border: 1px solid #a0a0a0;
            padding: 4px;
            margin-bottom: 6px;
            font-size: 0.85rem;
            text-align: center;
            background-color: white;
        }
        
        .poster-card {
            border: 1px solid #a0a0a0;
            background-color: white;
            height: 100%;
            display: flex;
            flex-direction: column;
            position: relative;
            margin-bottom: 6px;
            overflow: hidden;
        }
        
        .poster-card img {
            width: 100%;
            height: auto;
            aspect-ratio: 2/3;
            object-fit: contain;
            object-position: center top;
        }
        
        .poster-card .info-overlay {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background-color: rgba(0,0,0,0.7);
            color: white;
            padding: 5px;
            font-size: 11px;
            text-align: center;
        }
        
        .poster-card .title {
            font-weight: bold;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            margin-bottom: 2px;
        }
        
        .poster-card .rating {
            display: inline-block;
            background-color: #ffc107;
            color: #000;
            padding: 1px 4px;
            border-radius: 3px;
            font-weight: bold;
            font-size: 10px;
        }
        
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        
        .modal .window {
            width: 90%;
            max-width: 600px;
        }
        
        .scrollable-row {
            display: flex;
            overflow-x: auto;
            scroll-behavior: smooth;
            -webkit-overflow-scrolling: touch;
            gap: 8px;
            padding: 4px;
            scrollbar-width: thin;
        }
        
        .scrollable-row::-webkit-scrollbar {
            height: 8px;
        }
        
        .scrollable-row::-webkit-scrollbar-thumb {
            background: #a0a0a0;
            border-radius: 4px;
        }
        
        .scrollable-row::-webkit-scrollbar-track {
            background: #d4d0c8;
        }
        
        .scrollable-row .poster-item {
            flex: 0 0 auto;
            width: 200px;
            margin-bottom: 8px;
        }
        
        @media (max-width: 768px) {
            .tree-view li a {
                flex-wrap: wrap;
                padding: 10px 0;
            }
            
            .tree-view li a img {
                margin-bottom: 5px;
            }
            .poster-card img {
                width: 100%;
                height: auto;
            }
        }
        
        .activity-item {
            margin-bottom: 10px;
            background-color: #ffffff;
            border: 1px solid #a0a0a0;
            list-style-type: none;
            transition: background-color 0.2s;
        }
        
        .activity-item:hover {
            background-color: #efefef;
        }
        
        .activity-link {
            text-decoration: none;
            color: inherit;
            display: block;
        }
        
        .activity-content {
            display: flex;
            padding: 8px;
        }
        
        .activity-poster {
            width: 60px;
            height: 90px;
            object-fit: cover;
            border: 1px solid #d0d0d0;
            margin-right: 10px;
        }
        
        .activity-info {
            flex: 1;
        }
        
        .activity-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 4px;
            font-size: 12px;
        }
        
        .activity-username {
            font-weight: bold;
            color: #0000A0;
        }
        
        .activity-timestamp {
            color: #666;
            font-size: 11px;
        }
        
        .activity-title {
            font-weight: bold;
            margin-bottom: 4px;
        }
        
        .activity-text {
            font-style: italic;
            margin-bottom: 4px;
            font-size: 12px;
        }
        
        .activity-rating {
            display: inline-block;
            font-weight: bold;
            font-size: 18px;
            padding: 2px 6px;
            border-radius: 3px;
        }
        
        .high-rating {
            background-color: #4CAF50;
            color: white;
        }
        
        .mid-rating {
            background-color: #FFC107;
            color: black;
        }
        
        .low-rating {
            background-color: #F44336;
            color: white;
        }
        
        .rating-max {
            font-size: 12px;
            font-weight: normal;
        }
        
        .activity-action {
            font-size: 12px;
            color: #555;
        }
        
        #recent_activity {
            padding: 0;
            margin: 0;
        }
        
        @keyframes highlight {
            0% { background-color: #ffffcc; }
            100% { background-color: #ffffff; }
        }
        
        .new-activity {
            animation: highlight 3s ease-out;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .spinning {
            display: inline-block;
            animation: spin 1s infinite linear;
        }
        
        #refresh-indicator {
            font-size: 16px;
            font-weight: bold;
        }
    </style>
    
    <script>
        // Check if first-time visitor
        document.addEventListener('DOMContentLoaded', function() {
            if (!localStorage.getItem('returningUser')) {
                // Show welcome modal for first-time visitors
                document.getElementById('welcome-modal').style.display = 'flex';
                // Set flag in localStorage
                localStorage.setItem('returningUser', 'true');
            }
            
            // Set up tab functionality
            const tabButtons = document.querySelectorAll('.tab-btn');
            tabButtons.forEach(button => {
                button.addEventListener('click', () => {
                    // Hide all panels
                    document.querySelectorAll('.tab-panel').forEach(panel => {
                        panel.style.display = 'none';
                    });
                    
                    // Remove active class from all buttons
                    tabButtons.forEach(btn => {
                        btn.classList.remove('active');
                    });
                    
                    // Show the selected panel
                    const panelId = 'panel-' + button.id.split('-')[1];
                    document.getElementById(panelId).style.display = 'block';
                    
                    // Add active class to clicked button
                    button.classList.add('active');
                });
            });
        });
        
        // Close welcome modal
        function closeWelcomeModal() {
            document.getElementById('welcome-modal').style.display = 'none';
        }
        
        // Modal functions
        function openBookModal() {
            alert("Book feature coming soon!");
            // Implement book modal when ready
        }
    
        // Fetch popular movies
        fetch('/movies/popular/')
            .then(response => response.json())
            .then(data => {
                const movieList = document.getElementById('popular_movies_block');
                movieList.innerHTML = '';
                if (data.length === 0) {
                    movieList.innerHTML = '<div class="poster-item"><div class="poster-card">No movies found</div></div>';
                    return;
                }
                data.slice(0, 10).forEach(movie => {
                    const movieItem = document.createElement('div');
                    movieItem.className = 'poster-item';
                    movieItem.innerHTML = `
                        <div class="poster-card">
                            <a href="/movies/${movie.id}" style="text-decoration:none; color:inherit; display:block; height:100%;">
                                <img src="${movie.poster_path || '{% static "images/no-poster.png" %}'}" 
                                     alt="${movie.title}">
                                <div class="info-overlay">
                                    <div class="title">${movie.title}</div>
                                    <div class="rating">${movie.vote_average}/10</div>
                                </div>
                            </a>
                        </div>
                    `;
                    movieList.appendChild(movieItem);
                });
            })
            .catch(error => {
                console.error('Error fetching popular movies:', error);
                document.getElementById('popular_movies_block').innerHTML = 
                    '<div class="poster-item"><div class="alert alert-danger">Failed to load movies</div></div>';
            });
            
        // Fetch popular TV shows
        fetch('/tvshows/popular/')
            .then(response => response.json())
            .then(data => {
                const tvList = document.getElementById('popular_tvshows_block');
                tvList.innerHTML = '';
                if (data.length === 0) {
                    tvList.innerHTML = '<div class="poster-item"><div class="poster-card">No TV shows found</div></div>';
                    return;
                }
                data.slice(0, 10).forEach(show => {
                    const showItem = document.createElement('div');
                    showItem.className = 'poster-item';
                    showItem.innerHTML = `
                        <div class="poster-card">
                            <a href="/tvshows/${show.id}" style="text-decoration:none; color:inherit; display:block; height:100%;">
                                <img src="${show.poster_path || '{% static "images/no-poster.png" %}'}" 
                                     alt="${show.name}">
                                <div class="info-overlay">
                                    <div class="title">${show.name}</div>
                                    <div class="rating">${show.vote_average}/10</div>
                                </div>
                            </a>
                        </div>
                    `;
                    tvList.appendChild(showItem);
                });
            })
            .catch(error => {
                console.error('Error fetching popular TV shows:', error);
                document.getElementById('popular_tvshows_block').innerHTML = 
                    '<div class="poster-item"><div class="alert alert-danger">Failed to load TV shows</div></div>';
            });
            
        // For books and music tabs - placeholder data
        document.getElementById('popular_books_block').innerHTML = 
            '<div class="poster-item" style="width: 100%;"><div class="poster-card p-2" style="justify-content: center; align-items: center; display: flex; height: 140px;">Book integration coming soon!</div></div>';
        document.getElementById('popular_music_block').innerHTML = 
            '<div class="poster-item" style="width: 100%;"><div class="poster-card p-2" style="justify-content: center; align-items: center; display: flex; height: 140px;">Music integration coming soon!</div></div>';

        // Fetch movie recommendations
        fetch('/movies/recommendations/')
            .then(response => response.json())
            .then(data => {
                const movieList = document.getElementById('recommended_movies_block');
                movieList.innerHTML = '';
                if (data.length === 0) {
                    movieList.innerHTML = '<div class="poster-item"><div class="poster-card">No recommendations yet. Rate more movies to get personalized suggestions.</div></div>';
                    return;
                }
                data.forEach(movie => {
                    const movieItem = document.createElement('div');
                    movieItem.className = 'poster-item';
                    movieItem.innerHTML = `
                        <div class="poster-card">
                            <a href="/movies/${movie.tmdb_id}" style="text-decoration:none; color:inherit; display:block; height:100%;">
                                <img src="${movie.poster || '{% static "images/no-poster.png" %}'}" 
                                     alt="${movie.title}">
                                <div class="info-overlay">
                                    <div class="title">${movie.title}</div>
                                    <div class="rating">${movie.rating}/10</div>
                                </div>
                            </a>
                        </div>
                    `;
                    movieList.appendChild(movieItem);
                });
            })
            .catch(error => {
                console.error('Error fetching recommendations:', error);
                document.getElementById('recommended_movies_block').innerHTML = 
                    '<div class="poster-item"><div class="alert alert-danger">Failed to load recommendations</div></div>';
            });
            
        // Modified variables - removed lastActivityTimestamp since we don't need it
        let activityRefreshInterval = null;
        let isRefreshing = false;
        
        // Extract the activity fetching into a reusable function - modified to remove ?since parameter
        function fetchRecentActivity(showRefreshIndicator = true) {
            if (isRefreshing) return; // Prevent multiple concurrent requests
            isRefreshing = true;
            
            if (showRefreshIndicator) {
                // Show refresh indicator
                const indicator = document.getElementById('refresh-indicator');
                indicator.style.display = 'inline-block';
                indicator.classList.add('spinning');
            }
            
            fetch('/activity/recent/') // Removed the ?since parameter
                .then(response => response.json())
                .then(data => {
                    isRefreshing = false;
                    const activityList = document.getElementById('recent_activity');
                    
                    // Hide refresh indicator
                    document.getElementById('refresh-indicator').style.display = 'none';
                    document.getElementById('refresh-indicator').classList.remove('spinning');
                    
                    // Always update last updated time
                    const now = new Date();
                    document.getElementById('activity-last-updated').textContent = 
                        'Last updated: ' + now.toLocaleTimeString();
                    
                    // Always clear the list to display fresh data in correct order
                    activityList.innerHTML = '';
                    
                    if (data.length === 0) {
                        activityList.innerHTML = '<li class="activity-empty">No activity yet. Be the first to contribute!</li>';
                        return;
                    }
                    
                    // Add activities in the order they come from the server
                    data.forEach(activity => {
                        const activityItem = document.createElement('li');
                        activityItem.className = 'activity-item';
                        
                        // Build the poster placeholder
                        const posterPath = activity.poster_path || 'https://via.placeholder.com/60x90/333333/FFFFFF?text=No+Image';
                        
                        // Set URL based on content type
                        let detailUrl = '#';
                        if (activity.content_type === 'Movie' && activity.tmdb_id) {
                            detailUrl = `/movies/${activity.tmdb_id}`;
                        } else if (activity.content_type === 'TV Show' && activity.tmdb_id) {
                            detailUrl = `/tvshows/${activity.tmdb_id}`;
                        }
                        
                        // Build activity content based on what data is available
                        if ('rating' in activity) {
                            // This is a review activity
                            const ratingValue = Math.round(activity.rating);
                            const ratingClass = ratingValue >= 7 ? 'high-rating' : 
                                              ratingValue >= 5 ? 'mid-rating' : 'low-rating';
                            
                            activityItem.innerHTML = `
                                <a href="${detailUrl}" class="activity-link">
                                    <div class="activity-content">
                                        <img src="${posterPath}" alt="${activity.title}" class="activity-poster">
                                        <div class="activity-info">
                                            <div class="activity-header">
                                                <span class="activity-username">${activity.username}</span>
                                                <span class="activity-timestamp">${activity.timestamp}</span>
                                            </div>
                                            <div class="activity-title">${activity.content_type}: ${activity.title}</div>
                                            <div class="activity-text">${activity.content ? `"${activity.content}"` : ''}</div>
                                            <div class="activity-rating ${ratingClass}">${ratingValue}<span class="rating-max">/10</span></div>
                                        </div>
                                    </div>
                                </a>
                            `;
                        } 
                        else {
                            // This is a watchlist or new content activity
                            activityItem.innerHTML = `
                                <a href="${detailUrl}" class="activity-link">
                                    <div class="activity-content">
                                        <img src="${posterPath}" alt="${activity.title}" class="activity-poster">
                                        <div class="activity-info">
                                            <div class="activity-header">
                                                <span class="activity-username">${activity.username}</span>
                                                <span class="activity-timestamp">${activity.timestamp}</span>
                                            </div>
                                            <div class="activity-title">${activity.content_type}: ${activity.title}</div>
                                            <div class="activity-action">${activity.action}</div>
                                        </div>
                                    </div>
                                </a>
                            `;
                        }
                        
                        // Simply append to maintain server's order
                        activityList.appendChild(activityItem);
                    });
                    
                    // Limit the list to 10 items to avoid growing too large
                    while (activityList.children.length > 10) {
                        activityList.removeChild(activityList.lastChild);
                    }
                })
                .catch(error => {
                    isRefreshing = false;
                    console.error('Error fetching recent activity:', error);
                    
                    // Hide refresh indicator
                    document.getElementById('refresh-indicator').style.display = 'none';
                    document.getElementById('refresh-indicator').classList.remove('spinning');
                    
                    // Only show error if it's the initial load
                    if (activityList.children.length === 0) {
                        document.getElementById('recent_activity').innerHTML = 
                            '<li>Failed to load activity. Please try again later.</li>';
                    }
                });
        }
        
        // Set up auto-refresh toggle
        function setupAutoRefresh() {
            const autoRefreshCheckbox = document.getElementById('auto-refresh-toggle');
            
            // Initialize auto-refresh
            startAutoRefresh();
            
            // Toggle auto-refresh based on checkbox
            autoRefreshCheckbox.addEventListener('change', function() {
                if (this.checked) {
                    startAutoRefresh();
                } else {
                    stopAutoRefresh();
                }
            });
            
            // Stop refreshing when tab is not visible
            document.addEventListener('visibilitychange', function() {
                if (document.hidden) {
                    stopAutoRefresh();
                } else if (autoRefreshCheckbox.checked) {
                    startAutoRefresh();
                }
            });
        }
        
        function startAutoRefresh() {
            if (activityRefreshInterval) clearInterval(activityRefreshInterval);
            activityRefreshInterval = setInterval(fetchRecentActivity, 30000); // Check every 30 seconds
        }
        
        function stopAutoRefresh() {
            if (activityRefreshInterval) {
                clearInterval(activityRefreshInterval);
                activityRefreshInterval = null;
            }
        }
        
        // Call this when the page loads
        document.addEventListener('DOMContentLoaded', function() {
            // Existing DOMContentLoaded code
            if (!localStorage.getItem('returningUser')) {
                // Show welcome modal for first-time visitors
                document.getElementById('welcome-modal').style.display = 'flex';
                // Set flag in localStorage
                localStorage.setItem('returningUser', 'true');
            }
            
            // Set up tab functionality
            const tabButtons = document.querySelectorAll('.tab-btn');
            tabButtons.forEach(button => {
                button.addEventListener('click', () => {
                    // ...existing tab code...
                });
            });
            
            // Initial activity fetch (don't show refresh indicator for initial load)
            fetchRecentActivity(false);
            
            // Set up auto-refresh functionality
            setupAutoRefresh();
        });
    </script>
{% endblock %}