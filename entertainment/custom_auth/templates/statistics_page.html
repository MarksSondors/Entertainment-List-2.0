{% extends 'components/base.html' %}
{% load static %}

{% block title %}Statistics | Entertainment List{% endblock %}

{% block content %}
<style>
/* Theme-adaptive CSS variables (matching movie_page pattern) */
:root {
    --bg-color: #c0c0c0;
    --text-color: #000;
    --text-muted: #666;
    --border-dark: #808080;
    --border-light: #dfdfdf;
    --window-bg: #c0c0c0;
    --button-bg: #c0c0c0;
    --button-text: #000;
    --button-hover: #e0e0e0;
    --shadow-color: rgba(0,0,0,0.25);
}

@media (prefers-color-scheme: dark) {
    :root {
        --bg-color: #383838;
        --text-color: #ffffff;
        --text-muted: #b0b0b0;
        --border-dark: #2a2a2a;
        --border-light: #505050;
        --window-bg: #404040;
        --button-bg: #505050;
        --button-text: #ffffff;
        --button-hover: #606060;
        --shadow-color: rgba(0,0,0,0.5);
    }
}

/* Window styling */
.window {
    border: 2px outset var(--bg-color);
    background-color: var(--bg-color);
    font-family: 'MS Sans Serif', sans-serif;
    box-shadow: 2px 2px 4px var(--shadow-color);
    margin-bottom: 20px;
}

@media (prefers-color-scheme: dark) {
    .title-bar {
        background: linear-gradient(90deg, var(--win98-dark), var(--win98-light));
    }
}

.window-body {
    background-color: var(--window-bg);
    color: var(--text-color);
    padding: 12px;
}

/* ── Stats Page Layout ── */
.stats-container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 20px;
}

/* ── Win98 Tab Strip ── */
.stats-tabs {
    display: flex;
    gap: 0;
    margin-bottom: 10px;
}

.stats-tab {
    display: flex;
    align-items: center;
    gap: 6px;
    padding: 6px 16px;
    border: 2px outset var(--bg-color);
    background: var(--bg-color);
    color: var(--text-color);
    font-family: 'Pixelated MS Sans Serif', 'MS Sans Serif', Arial, sans-serif;
    font-size: 13px;
    cursor: pointer;
    margin-right: 2px;
}

.stats-tab:hover {
    background: var(--button-hover);
}

.stats-tab.active {
    border-style: inset;
    background: var(--window-bg);
    font-weight: bold;
}

.stats-tab .win98-icon {
    width: 16px;
    height: 16px;
    image-rendering: pixelated;
}

/* ── Controls Row ── */
.stats-controls {
    display: flex;
    align-items: center;
    justify-content: space-between;
    flex-wrap: wrap;
    gap: 10px;
    margin-bottom: 16px;
}

.year-filter {
    display: flex;
    align-items: center;
    gap: 6px;
}

.year-filter .win98-icon {
    width: 16px;
    height: 16px;
    image-rendering: pixelated;
}

.year-filter select {
    font-family: 'Pixelated MS Sans Serif', 'MS Sans Serif', Arial, sans-serif;
    font-size: 12px;
    min-width: 120px;
}

.stats-total {
    font-size: 12px;
    color: var(--text-muted);
    padding: 4px 10px;
    border: 1px inset var(--bg-color);
    background: var(--window-bg);
}

/* ── Chart Grid ── */
.stats-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 16px;
}

@media (max-width: 768px) {
    .stats-grid {
        grid-template-columns: 1fr;
    }
    .stats-controls {
        flex-direction: column;
        align-items: flex-start;
    }
}

.stats-grid .window {
    margin-bottom: 0;
    box-shadow: none;
    border: 2px solid var(--border-dark);
    border-right-color: var(--border-light);
    border-bottom-color: var(--border-light);
}

.stats-grid .window .window-body {
    padding: 8px;
    min-height: 300px;
    display: flex;
    align-items: center;
    justify-content: center;
}

.stats-grid .title-bar {
    min-height: 20px;
    height: 22px;
}

.stats-grid .title-bar-text {
    display: flex;
    align-items: center;
    gap: 6px;
    font-size: 12px;
}

.stats-grid .title-bar-text .win98-icon {
    width: 14px;
    height: 14px;
    image-rendering: pixelated;
}

.chart-container {
    width: 100%;
    height: 100%;
    min-height: 280px;
}

/* ── Summary Cards ── */
.stats-summary {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 12px;
    margin-bottom: 16px;
}

@media (max-width: 768px) {
    .stats-summary {
        grid-template-columns: 1fr;
    }
}

.summary-card {
    border: 2px inset var(--bg-color);
    background: var(--window-bg);
    padding: 12px 16px;
    display: flex;
    align-items: center;
    gap: 12px;
}

.summary-card .win98-icon {
    width: 32px;
    height: 32px;
    image-rendering: pixelated;
    flex-shrink: 0;
}

.summary-card .summary-info {
    display: flex;
    flex-direction: column;
}

.summary-card .summary-value {
    font-size: 20px;
    font-weight: bold;
    color: var(--text-color);
    font-family: 'Pixelated MS Sans Serif', 'MS Sans Serif', Arial, sans-serif;
    line-height: 1.2;
}

.summary-card .summary-label {
    font-size: 11px;
    color: var(--text-muted);
    font-family: 'Pixelated MS Sans Serif', 'MS Sans Serif', Arial, sans-serif;
}

/* ── Top Directors List ── */
.top-directors-list {
    width: 100%;
    font-family: 'Pixelated MS Sans Serif', 'MS Sans Serif', Arial, sans-serif;
    font-size: 12px;
}

.top-directors-list .director-row {
    display: flex;
    align-items: center;
    padding: 4px 8px;
    border-bottom: 1px solid var(--border-dark);
    gap: 8px;
}

.top-directors-list .director-row:last-child {
    border-bottom: none;
}

.top-directors-list .director-rank {
    width: 20px;
    text-align: center;
    color: var(--text-muted);
    font-weight: bold;
    flex-shrink: 0;
}

.top-directors-list .director-name {
    flex: 1;
    color: var(--text-color);
}

.top-directors-list .director-count {
    color: var(--text-muted);
    font-size: 11px;
    flex-shrink: 0;
}

.top-directors-list .director-rating {
    color: #008080;
    font-weight: bold;
    white-space: nowrap;
    text-align: right;
    flex-shrink: 0;
}

/* ── Full-width chart ── */
.stats-grid .full-width {
    grid-column: 1 / -1;
}

/* ── Empty State (Win98 Error Dialog) ── */
.stats-empty-state {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    width: 100%;
    grid-column: 1 / -1;
    padding: 40px 0;
}

.stats-empty-dialog {
    max-width: 340px;
    width: 100%;
    box-shadow: 2px 2px 4px var(--shadow-color) !important;
    border: 2px outset var(--bg-color) !important;
}

.stats-empty-dialog .window-body {
    min-height: auto;
    display: flex;
    align-items: flex-start;
    gap: 12px;
    padding: 16px;
}

.stats-empty-dialog .win98-icon-large {
    width: 32px;
    height: 32px;
    image-rendering: pixelated;
    flex-shrink: 0;
}

.stats-empty-dialog p {
    margin: 0;
    font-size: 12px;
    color: var(--text-color);
    line-height: 1.5;
}

.stats-empty-dialog .dialog-buttons {
    display: flex;
    justify-content: center;
    padding: 8px 16px 12px;
    background: var(--window-bg);
}

.stats-empty-dialog .dialog-buttons button {
    min-width: 75px;
}

/* ── Status Bar ── */
.stats-status-bar {
    border-top: 1px solid var(--border-dark);
    background-color: var(--bg-color);
    padding: 2px 4px;
    font-size: 11px;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.stats-status-bar .status-bar-field {
    border: 1px inset var(--bg-color);
    padding: 2px 6px;
    background-color: var(--bg-color);
    color: var(--text-color);
}

/* ── ApexCharts Theme Overrides ── */
.apexcharts-tooltip {
    border: 2px outset var(--bg-color) !important;
    background: var(--window-bg) !important;
    color: var(--text-color) !important;
    border-radius: 0 !important;
    box-shadow: 2px 2px 4px var(--shadow-color) !important;
    font-family: 'Pixelated MS Sans Serif', 'MS Sans Serif', Arial, sans-serif !important;
    font-size: 11px !important;
}

.apexcharts-tooltip-title {
    background: var(--bg-color) !important;
    border-bottom: 1px solid var(--border-dark) !important;
    font-family: 'Pixelated MS Sans Serif', 'MS Sans Serif', Arial, sans-serif !important;
    font-size: 11px !important;
    color: var(--text-color) !important;
}

.apexcharts-xaxistooltip,
.apexcharts-yaxistooltip {
    border: 2px outset var(--bg-color) !important;
    background: var(--window-bg) !important;
    color: var(--text-color) !important;
    border-radius: 0 !important;
}

.apexcharts-xaxistooltip:after,
.apexcharts-xaxistooltip:before {
    border-bottom-color: var(--window-bg) !important;
}

.apexcharts-menu {
    border: 2px outset var(--bg-color) !important;
    background: var(--window-bg) !important;
    border-radius: 0 !important;
}

.apexcharts-menu-item:hover {
    background: var(--button-hover) !important;
}
</style>

<div class="stats-container">
    <!-- Outer Window - wraps entire page -->
    <div class="window">
        <div class="title-bar">
            <div class="title-bar-text">Statistics - {{ request.user.username }}</div>
            <div class="title-bar-controls">
                <button aria-label="Minimize"></button>
                <button aria-label="Maximize"></button>
                <button aria-label="Close"></button>
            </div>
        </div>
        <div class="window-body">
            <!-- Tab strip -->
            <div class="stats-tabs">
                <button class="stats-tab active" data-media="movies" onclick="switchTab('movies', this)">
                    <img src="{% static 'images/win98/camera_vid.png' %}" alt="" class="win98-icon"> Movies
                </button>
                <button class="stats-tab" data-media="tvshows" onclick="switchTab('tvshows', this)">
                    <img src="{% static 'images/win98/network_television.png' %}" alt="" class="win98-icon"> TV Shows
                </button>
                <button class="stats-tab" data-media="games" onclick="switchTab('games', this)">
                    <img src="{% static 'images/win98/solitaire.png' %}" alt="" class="win98-icon"> Games
                </button>
            </div>

            <!-- Controls row -->
            <div class="stats-controls">
                <span class="stats-total" id="total-reviews"></span>
                <div class="year-filter">
                    <img src="{% static 'images/win98/calendar.png' %}" alt="" class="win98-icon">
                    <select id="year-select" onchange="onYearChange()">
                        <option value="all">All Time</option>
                    </select>
                </div>
            </div>

            <!-- Summary cards -->
            <div class="stats-summary" id="stats-summary">
                <div class="summary-card">
                    <img src="{% static 'images/win98/star-in-win-98 style.png' %}" alt="" class="win98-icon">
                    <div class="summary-info">
                        <span class="summary-value" id="summary-total">0</span>
                        <span class="summary-label">Total Rated</span>
                    </div>
                </div>
                <div class="summary-card" id="summary-hours-card">
                    <img src="{% static 'images/win98/clock.png' %}" alt="" class="win98-icon">
                    <div class="summary-info">
                        <span class="summary-value" id="summary-hours">0</span>
                        <span class="summary-label">Hours</span>
                    </div>
                </div>
                <div class="summary-card">
                    <img src="{% static 'images/win98/favorites.png' %}" alt="" class="win98-icon">
                    <div class="summary-info">
                        <span class="summary-value" id="summary-avg">0</span>
                        <span class="summary-label">Avg Rating</span>
                    </div>
                </div>
            </div>

            <!-- Chart panels grid -->
            <div class="stats-grid" id="stats-grid">
                <!-- Rating Distribution -->
                <div class="window">
                    <div class="title-bar">
                        <div class="title-bar-text">
                            <img src="{% static 'images/win98/star-in-win-98 style.png' %}" alt="" class="win98-icon">
                            Rating Distribution
                        </div>
                    </div>
                    <div class="window-body">
                        <div id="chart-rating-dist" class="chart-container"></div>
                    </div>
                </div>

                <!-- Ratings Over Time -->
                <div class="window">
                    <div class="title-bar">
                        <div class="title-bar-text">
                            <img src="{% static 'images/win98/notepad_file.png' %}" alt="" class="win98-icon">
                            Ratings Over Time
                        </div>
                    </div>
                    <div class="window-body">
                        <div id="chart-ratings-time" class="chart-container"></div>
                    </div>
                </div>

                <!-- Release Years -->
                <div class="window">
                    <div class="title-bar">
                        <div class="title-bar-text">
                            <img src="{% static 'images/win98/calendar.png' %}" alt="" class="win98-icon">
                            Release Years
                        </div>
                    </div>
                    <div class="window-body">
                        <div id="chart-release-years" class="chart-container"></div>
                    </div>
                </div>

                <!-- Average Rating by Release Year -->
                <div class="window">
                    <div class="title-bar">
                        <div class="title-bar-text">
                            <img src="{% static 'images/win98/calendar.png' %}" alt="" class="win98-icon">
                            Avg Rating by Release Year
                        </div>
                    </div>
                    <div class="window-body">
                        <div id="chart-avg-year" class="chart-container"></div>
                    </div>
                </div>

                <!-- Rated per Genre -->
                <div class="window">
                    <div class="title-bar">
                        <div class="title-bar-text">
                            <img src="{% static 'images/win98/directory_closed.png' %}" alt="" class="win98-icon">
                            Rated per Genre
                        </div>
                    </div>
                    <div class="window-body">
                        <div id="chart-genre-count" class="chart-container"></div>
                    </div>
                </div>

                <!-- Average Rating per Genre -->
                <div class="window">
                    <div class="title-bar">
                        <div class="title-bar-text">
                            <img src="{% static 'images/win98/directory_closed.png' %}" alt="" class="win98-icon">
                            Avg Rating per Genre
                        </div>
                    </div>
                    <div class="window-body">
                        <div id="chart-genre-avg" class="chart-container"></div>
                    </div>
                </div>

                <!-- Watch Time by Month (Movies & TV only) -->
                <div class="window full-width" id="watch-time-window">
                    <div class="title-bar">
                        <div class="title-bar-text">
                            <img src="{% static 'images/win98/clock.png' %}" alt="" class="win98-icon">
                            Watch Time by Month
                        </div>
                    </div>
                    <div class="window-body">
                        <div id="chart-watch-time" class="chart-container"></div>
                    </div>
                </div>

                <!-- Top Directors by Count (Movies only) -->
                <div class="window directors-panel" id="top-directors-window">
                    <div class="title-bar">
                        <div class="title-bar-text">
                            <img src="{% static 'images/win98/users.png' %}" alt="" class="win98-icon">
                            Top Directors (Most Films)
                        </div>
                    </div>
                    <div class="window-body">
                        <div id="top-directors-container" class="chart-container" style="min-height: auto;"></div>
                    </div>
                </div>

                <!-- Top Directors by Rating (Movies only) -->
                <div class="window directors-panel" id="top-directors-rating-window">
                    <div class="title-bar">
                        <div class="title-bar-text">
                            <img src="{% static 'images/win98/star-in-win-98 style.png' %}" alt="" class="win98-icon">
                            Top Directors (By Rating)
                        </div>
                    </div>
                    <div class="window-body">
                        <div id="top-directors-rating-container" class="chart-container" style="min-height: auto;"></div>
                    </div>
                </div>

                <!-- Top Actors by Count (Movies & TV) -->
                <div class="window actors-panel" id="top-actors-window">
                    <div class="title-bar">
                        <div class="title-bar-text">
                            <img src="{% static 'images/win98/users.png' %}" alt="" class="win98-icon">
                            Top Actors (Most Films)
                        </div>
                    </div>
                    <div class="window-body">
                        <div id="top-actors-container" class="chart-container" style="min-height: auto;"></div>
                    </div>
                </div>

                <!-- Top Actors by Rating (Movies & TV) -->
                <div class="window actors-panel" id="top-actors-rating-window">
                    <div class="title-bar">
                        <div class="title-bar-text">
                            <img src="{% static 'images/win98/star-in-win-98 style.png' %}" alt="" class="win98-icon">
                            Top Actors (By Rating)
                        </div>
                    </div>
                    <div class="window-body">
                        <div id="top-actors-rating-container" class="chart-container" style="min-height: auto;"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Status bar -->
        <div class="stats-status-bar">
            <div class="status-bar-field" id="status-bar-info">Ready</div>
            <div class="status-bar-field" id="status-bar-count"></div>
        </div>
    </div>
</div>

<!-- Empty state template (hidden, cloned by JS) -->
<template id="empty-state-template">
    <div class="stats-empty-state">
        <div class="window stats-empty-dialog">
            <div class="title-bar">
                <div class="title-bar-text">stats.exe</div>
                <div class="title-bar-controls">
                    <button aria-label="Close"></button>
                </div>
            </div>
            <div class="window-body">
                <img src="{% static 'images/win98/msg_error.png' %}" alt="" class="win98-icon-large">
                <p>No ratings yet for this category.<br>Start rating to see your stats!</p>
            </div>
            <div class="dialog-buttons">
                <button onclick="window.location.href='{% url 'profile_page' %}'">OK</button>
            </div>
        </div>
    </div>
</template>

<!-- ApexCharts CDN -->
<script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>

<script>
(function() {
    'use strict';

    // ── Data from Django ──
    const statsData = {{ stats_json|safe }};

    // ── Theme detection ──
    const isDark = window.matchMedia('(prefers-color-scheme: dark)');

    function getColors() {
        const dark = isDark.matches;
        return {
            text:       dark ? '#e0e0e0' : '#000000',
            muted:      dark ? '#b0b0b0' : '#666666',
            gridLine:   dark ? '#505050' : '#c0c0c0',
            background: 'transparent',
            // Win98 palette for series
            palette: ['#008080', '#000080', '#808000', '#800080', '#008000', '#800000', '#4682B4', '#CD853F', '#708090', '#2E8B57'],
            primary:    '#008080',
        };
    }

    // ── Shared ApexCharts defaults ──
    function baseOptions(overrides) {
        const c = getColors();
        return Object.assign({
            chart: {
                fontFamily: "'Pixelated MS Sans Serif', 'MS Sans Serif', Arial, sans-serif",
                background: c.background,
                toolbar: { show: false },
                animations: { enabled: true, easing: 'easeinout', speed: 400 },
            },
            theme: { mode: isDark.matches ? 'dark' : 'light' },
            grid: {
                borderColor: c.gridLine,
                strokeDashArray: 3,
            },
            xaxis: {
                labels: { style: { colors: c.text, fontSize: '10px' } },
                axisBorder: { color: c.gridLine },
                axisTicks: { color: c.gridLine },
            },
            yaxis: {
                labels: { style: { colors: c.text, fontSize: '10px' } },
            },
            tooltip: {
                theme: isDark.matches ? 'dark' : 'light',
            },
            dataLabels: { enabled: false },
            states: {
                hover: { filter: { type: 'darken', value: 0.85 } },
                active: { filter: { type: 'darken', value: 0.8 } },
            },
        }, overrides);
    }

    // ── Chart instances (destroyed on re-render) ──
    let charts = {};

    function destroyCharts() {
        Object.values(charts).forEach(chart => {
            try { chart.destroy(); } catch(e) {}
        });
        charts = {};
    }

    // ── Get data for current tab + year ──
    function getData(mediaType, year) {
        const media = statsData[mediaType];
        if (!media || media.total_reviews === 0) return null;

        if (year === 'all') {
            return {
                summary:              media.summary,
                rating_distribution:  media.rating_distribution,
                ratings_over_time:    media.ratings_over_time,
                release_year_distribution: media.release_year_distribution,
                avg_rating_by_release_year: media.avg_rating_by_release_year,
                count_by_genre:       media.count_by_genre,
                avg_rating_by_genre:  media.avg_rating_by_genre,
                watch_time_by_month:  media.watch_time_by_month,
                top_directors:        media.top_directors,
                top_directors_by_rating: media.top_directors_by_rating,
                top_actors:           media.top_actors,
                top_actors_by_rating: media.top_actors_by_rating,
            };
        }

        const yearData = media.yearly[String(year)];
        return yearData || null;
    }

    // ── Show/hide empty state ──
    function showEmptyState() {
        const grid = document.getElementById('stats-grid');
        // Hide only the chart windows (direct children), not nested ones
        Array.from(grid.children).forEach(w => {
            if (w.classList.contains('window')) w.style.display = 'none';
        });

        // Check if we already appended an empty state
        let existing = grid.querySelector('.stats-empty-state');
        if (!existing) {
            const tpl = document.getElementById('empty-state-template');
            const clone = tpl.content.cloneNode(true);
            grid.appendChild(clone);
        }
    }

    function hideEmptyState() {
        const grid = document.getElementById('stats-grid');
        const empty = grid.querySelector('.stats-empty-state');
        if (empty) empty.remove();
        Array.from(grid.children).forEach(w => {
            if (w.classList.contains('window')) w.style.display = '';
        });
    }

    // ── Update summary cards ──
    function updateSummary(data, mediaType) {
        const summary = data ? data.summary : null;
        document.getElementById('summary-total').textContent = summary ? summary.total_rated : 0;
        document.getElementById('summary-hours').textContent = summary ? summary.total_hours : 0;
        document.getElementById('summary-avg').textContent = summary ? summary.avg_rating : 0;

        // Hide hours card for games (no runtime)
        const hoursCard = document.getElementById('summary-hours-card');
        hoursCard.style.display = mediaType === 'games' ? 'none' : '';
    }

    // ── Render all charts ──
    function renderCharts(mediaType, year) {
        destroyCharts();

        const data = getData(mediaType, year);
        const total = statsData[mediaType] ? statsData[mediaType].total_reviews : 0;

        // Update total badge + status bar
        const label = { movies: 'Movies', tvshows: 'TV Shows', games: 'Games' }[mediaType];
        document.getElementById('total-reviews').textContent = total + ' ' + label + ' Rated';
        document.getElementById('status-bar-info').textContent = label + ' Statistics';
        document.getElementById('status-bar-count').textContent = total + ' items';

        // Show/hide watch time panel
        const watchTimeWindow = document.getElementById('watch-time-window');
        watchTimeWindow.style.display = mediaType === 'games' ? 'none' : '';

        // Update summary cards
        updateSummary(data, mediaType);

        if (!data) {
            showEmptyState();
            return;
        }

        // Check if this particular year slice is empty
        const hasData = Object.values(data.rating_distribution || {}).some(v => v > 0);
        if (!hasData && (!data.ratings_over_time || data.ratings_over_time.length === 0)) {
            showEmptyState();
            return;
        }

        hideEmptyState();

        // Show/hide people panels based on media type (after hideEmptyState which resets display)
        const directorPanels = document.querySelectorAll('.directors-panel');
        const actorPanels = document.querySelectorAll('.actors-panel');
        directorPanels.forEach(p => p.style.display = mediaType === 'movies' ? '' : 'none');
        actorPanels.forEach(p => p.style.display = mediaType === 'games' ? 'none' : '');

        const c = getColors();

        // 1. Rating Distribution — bar chart
        const distLabels = Object.keys(data.rating_distribution);
        const distValues = Object.values(data.rating_distribution);
        charts.ratingDist = new ApexCharts(
            document.querySelector('#chart-rating-dist'),
            baseOptions({
                chart: { type: 'bar', height: 280, fontFamily: "'Pixelated MS Sans Serif', 'MS Sans Serif', Arial, sans-serif", background: c.background, toolbar: { show: false } },
                series: [{ name: 'Count', data: distValues }],
                xaxis: {
                    categories: distLabels,
                    title: { text: 'Rating', style: { color: c.text, fontSize: '10px' } },
                    labels: { style: { colors: c.text, fontSize: '10px' } },
                    axisBorder: { color: c.gridLine }, axisTicks: { color: c.gridLine },
                },
                yaxis: {
                    title: { text: 'Count', style: { color: c.text, fontSize: '10px' } },
                    labels: { style: { colors: c.text, fontSize: '10px' } },
                },
                colors: [c.primary],
                plotOptions: { bar: { borderRadius: 0, columnWidth: '70%' } },
            })
        );
        charts.ratingDist.render();

        // 2. Ratings Over Time — scatter
        const timeData = (data.ratings_over_time || []).map(d => ({ x: new Date(d.date).getTime(), y: d.rating }));
        charts.ratingsTime = new ApexCharts(
            document.querySelector('#chart-ratings-time'),
            baseOptions({
                chart: { type: 'scatter', height: 280, fontFamily: "'Pixelated MS Sans Serif', 'MS Sans Serif', Arial, sans-serif", background: c.background, toolbar: { show: false }, zoom: { enabled: false } },
                series: [{ name: 'Rating', data: timeData }],
                xaxis: {
                    type: 'datetime',
                    labels: { style: { colors: c.text, fontSize: '10px' }, datetimeUTC: false },
                    axisBorder: { color: c.gridLine }, axisTicks: { color: c.gridLine },
                },
                yaxis: {
                    min: 0, max: 10,
                    title: { text: 'Rating', style: { color: c.text, fontSize: '10px' } },
                    labels: { style: { colors: c.text, fontSize: '10px' } },
                },
                colors: [c.primary],
                markers: { size: 4, strokeWidth: 0 },
            })
        );
        charts.ratingsTime.render();

        // 3. Release Years — bar chart
        const releaseLabels = Object.keys(data.release_year_distribution);
        const releaseValues = Object.values(data.release_year_distribution);
        charts.releaseYears = new ApexCharts(
            document.querySelector('#chart-release-years'),
            baseOptions({
                chart: { type: 'bar', height: 280, fontFamily: "'Pixelated MS Sans Serif', 'MS Sans Serif', Arial, sans-serif", background: c.background, toolbar: { show: false } },
                series: [{ name: 'Count', data: releaseValues }],
                xaxis: {
                    categories: releaseLabels,
                    title: { text: 'Release Year', style: { color: c.text, fontSize: '10px' } },
                    labels: { style: { colors: c.text, fontSize: '10px' }, rotate: -45, rotateAlways: releaseLabels.length > 15 },
                    axisBorder: { color: c.gridLine }, axisTicks: { color: c.gridLine },
                },
                yaxis: {
                    title: { text: 'Count', style: { color: c.text, fontSize: '10px' } },
                    labels: { style: { colors: c.text, fontSize: '10px' } },
                },
                colors: ['#000080'],
                plotOptions: { bar: { borderRadius: 0, columnWidth: '70%' } },
            })
        );
        charts.releaseYears.render();

        // 4. Average Rating by Release Year — line chart
        const avgYearLabels = Object.keys(data.avg_rating_by_release_year || {});
        const avgYearValues = Object.values(data.avg_rating_by_release_year || {});
        charts.avgYear = new ApexCharts(
            document.querySelector('#chart-avg-year'),
            baseOptions({
                chart: { type: 'line', height: 280, fontFamily: "'Pixelated MS Sans Serif', 'MS Sans Serif', Arial, sans-serif", background: c.background, toolbar: { show: false } },
                series: [{ name: 'Avg Rating', data: avgYearValues }],
                xaxis: {
                    categories: avgYearLabels,
                    title: { text: 'Release Year', style: { color: c.text, fontSize: '10px' } },
                    labels: { style: { colors: c.text, fontSize: '10px' } },
                    axisBorder: { color: c.gridLine }, axisTicks: { color: c.gridLine },
                },
                yaxis: {
                    min: 0, max: 10,
                    title: { text: 'Avg Rating', style: { color: c.text, fontSize: '10px' } },
                    labels: { style: { colors: c.text, fontSize: '10px' } },
                },
                colors: [c.primary],
                stroke: { width: 2, curve: 'straight' },
                markers: { size: 4, strokeWidth: 0 },
            })
        );
        charts.avgYear.render();

        // 5. Rated per Genre — horizontal bar
        const genreCountLabels = Object.keys(data.count_by_genre);
        const genreCountValues = Object.values(data.count_by_genre);
        const genreCountHeight = Math.max(280, genreCountLabels.length * 28);
        charts.genreCount = new ApexCharts(
            document.querySelector('#chart-genre-count'),
            baseOptions({
                chart: { type: 'bar', height: genreCountHeight, fontFamily: "'Pixelated MS Sans Serif', 'MS Sans Serif', Arial, sans-serif", background: c.background, toolbar: { show: false } },
                series: [{ name: 'Count', data: genreCountValues }],
                xaxis: {
                    categories: genreCountLabels,
                    title: { text: 'Count', style: { color: c.text, fontSize: '10px' } },
                    labels: { style: { colors: c.text, fontSize: '10px' } },
                    axisBorder: { color: c.gridLine }, axisTicks: { color: c.gridLine },
                },
                yaxis: {
                    labels: { style: { colors: c.text, fontSize: '10px' } },
                },
                colors: c.palette,
                plotOptions: { bar: { horizontal: true, borderRadius: 0, barHeight: '65%', distributed: true } },
                legend: { show: false },
            })
        );
        charts.genreCount.render();

        // 6. Avg Rating per Genre — horizontal bar
        const genreAvgLabels = Object.keys(data.avg_rating_by_genre);
        const genreAvgValues = Object.values(data.avg_rating_by_genre);
        const genreAvgHeight = Math.max(280, genreAvgLabels.length * 28);
        charts.genreAvg = new ApexCharts(
            document.querySelector('#chart-genre-avg'),
            baseOptions({
                chart: { type: 'bar', height: genreAvgHeight, fontFamily: "'Pixelated MS Sans Serif', 'MS Sans Serif', Arial, sans-serif", background: c.background, toolbar: { show: false } },
                series: [{ name: 'Avg Rating', data: genreAvgValues }],
                xaxis: {
                    categories: genreAvgLabels,
                    min: 0, max: 10,
                    title: { text: 'Avg Rating', style: { color: c.text, fontSize: '10px' } },
                    labels: { style: { colors: c.text, fontSize: '10px' } },
                    axisBorder: { color: c.gridLine }, axisTicks: { color: c.gridLine },
                },
                yaxis: {
                    labels: { style: { colors: c.text, fontSize: '10px' } },
                },
                colors: c.palette,
                plotOptions: { bar: { horizontal: true, borderRadius: 0, barHeight: '65%', distributed: true } },
                legend: { show: false },
            })
        );
        charts.genreAvg.render();

        // 7. Watch Time by Month — area chart (Movies & TV only)
        if (mediaType !== 'games') {
            const wtData = data.watch_time_by_month || [];
            if (Array.isArray(wtData) && wtData.length > 0) {
                const wtLabels = wtData.map(d => d.month);
                const wtValues = wtData.map(d => d.hours);
                charts.watchTime = new ApexCharts(
                    document.querySelector('#chart-watch-time'),
                    baseOptions({
                        chart: { type: 'area', height: 280, fontFamily: "'Pixelated MS Sans Serif', 'MS Sans Serif', Arial, sans-serif", background: c.background, toolbar: { show: false } },
                        series: [{ name: 'Hours', data: wtValues }],
                        xaxis: {
                            categories: wtLabels,
                            title: { text: 'Month', style: { color: c.text, fontSize: '10px' } },
                            labels: { style: { colors: c.text, fontSize: '10px' }, rotate: -45, rotateAlways: wtLabels.length > 10 },
                            axisBorder: { color: c.gridLine }, axisTicks: { color: c.gridLine },
                        },
                        yaxis: {
                            title: { text: 'Hours', style: { color: c.text, fontSize: '10px' } },
                            labels: { style: { colors: c.text, fontSize: '10px' } },
                        },
                        colors: ['#008080'],
                        fill: { type: 'gradient', gradient: { shadeIntensity: 1, opacityFrom: 0.5, opacityTo: 0.1 } },
                        stroke: { width: 2, curve: 'smooth' },
                        dataLabels: { enabled: false },
                    })
                );
                charts.watchTime.render();
            } else {
                document.querySelector('#chart-watch-time').innerHTML = '<div style="text-align:center;color:var(--text-muted);font-size:12px;padding:40px;">No watch time data available</div>';
            }
        }

        // 8. Top Directors (Movies only)
        if (mediaType === 'movies') {
            renderPeopleList('top-directors-container', data.top_directors, 'No director data', 'film');
            renderPeopleList('top-directors-rating-container', data.top_directors_by_rating, 'Not enough data (min 2 films per director)', 'film');
        }

        // 9. Top Actors (Movies & TV)
        if (mediaType !== 'games') {
            const itemLabel = mediaType === 'movies' ? 'film' : 'show';
            renderPeopleList('top-actors-container', data.top_actors, 'No actor data', itemLabel);
            renderPeopleList('top-actors-rating-container', data.top_actors_by_rating, 'Not enough data (min 2 titles per actor)', itemLabel);
        }
    }

    function renderPeopleList(containerId, people, emptyMsg, itemLabel) {
        const container = document.getElementById(containerId);
        const list = people || [];
        if (list.length > 0) {
            let html = '<div class="top-directors-list">';
            list.forEach((d, i) => {
                const plural = d.count !== 1 ? (itemLabel + 's') : itemLabel;
                html += `<div class="director-row">
                    <span class="director-rank">${i + 1}</span>
                    <span class="director-name">${d.name}</span>
                    <span class="director-count">${d.count} ${plural}</span>
                    <span class="director-rating">★ ${d.avg_rating}</span>
                </div>`;
            });
            html += '</div>';
            container.innerHTML = html;
        } else {
            container.innerHTML = '<div style="text-align:center;color:var(--text-muted);font-size:12px;padding:40px;">' + emptyMsg + '</div>';
        }
    }

    // ── Tab switching ──
    let currentMedia = 'movies';

    window.switchTab = function(mediaType, btn) {
        currentMedia = mediaType;

        // Update tab styling
        document.querySelectorAll('.stats-tab').forEach(t => t.classList.remove('active'));
        btn.classList.add('active');

        // Rebuild year dropdown for this media type
        const yearSelect = document.getElementById('year-select');
        const years = statsData[mediaType] ? statsData[mediaType].years : [];
        yearSelect.innerHTML = '<option value="all">All Time</option>';
        years.forEach(y => {
            const opt = document.createElement('option');
            opt.value = y;
            opt.textContent = y;
            yearSelect.appendChild(opt);
        });

        renderCharts(mediaType, 'all');
    };

    // ── Year change ──
    window.onYearChange = function() {
        const year = document.getElementById('year-select').value;
        renderCharts(currentMedia, year);
    };

    // ── Dark mode change → re-render ──
    isDark.addEventListener('change', function() {
        const year = document.getElementById('year-select').value;
        renderCharts(currentMedia, year);
    });

    // ── Initial render ──
    document.addEventListener('DOMContentLoaded', function() {
        // Populate initial year dropdown
        const yearSelect = document.getElementById('year-select');
        const years = statsData.movies ? statsData.movies.years : [];
        years.forEach(y => {
            const opt = document.createElement('option');
            opt.value = y;
            opt.textContent = y;
            yearSelect.appendChild(opt);
        });

        renderCharts('movies', 'all');
    });

})();
</script>
{% endblock %}
