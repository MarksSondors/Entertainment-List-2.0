{% extends 'components/base.html' %}
{% load static %}

{% block title %}My Watchlist | Entertainment List{% endblock %}

{% block content %}
<div class="watchlist-container">
  <div class="window">
    <div class="title-bar">
      <div class="title-bar-text">My Watchlist</div>
      <div class="title-bar-controls">
        <button aria-label="Minimize"></button>
        <button aria-label="Maximize"></button>
        <button aria-label="Close"></button>
      </div>
    </div>
    <div class="window-body">
      <!-- Hidden Filter Form -->
      <form method="get" action="" class="filter-form" id="filterForm" style="display: none;">
        <div class="window">
          <div class="title-bar">
            <div class="title-bar-text">ðŸ”§ Filters & Sorting</div>
            <div class="title-bar-controls">
              <button aria-label="Minimize"></button>
              <button aria-label="Maximize"></button>
              <button aria-label="Close" type="button" onclick="toggleFilters()"></button>
            </div>
          </div>
          <div class="window-body">
            <div class="filter-group">
              <label>Search:</label>
              <input type="text" id="searchInput" placeholder="Search titles..." class="address-input">
            </div>
            
            <div class="filter-group">
              <label>Genre:</label>
              <select id="genreFilter" class="address-input">
                <option value="">All Genres</option>
                {% for genre in genres %}
                <option value="{{ genre.id }}">{{ genre.name }}</option>
                {% endfor %}
              </select>
            </div>

            <div class="filter-group">
              <label>Country:</label>
              <select id="countryFilter" class="address-input">
                <option value="">All Countries</option>
                {% for country in countries %}
                <option value="{{ country.id }}">{{ country.name }}</option>
                {% endfor %}
              </select>
            </div>
            
            <div class="filter-group">
              <label>Sort By:</label>
              <div class="btn-group" role="group">
                <input type="radio" name="sort_by" id="date_added" value="date_added" checked>
                <label for="date_added" class="retro-btn filter-btn">Date Added</label>
                
                <input type="radio" name="sort_by" id="title_asc" value="title">
                <label for="title_asc" class="retro-btn filter-btn">Title (A-Z)</label>
                
                <input type="radio" name="sort_by" id="title_desc" value="-title">
                <label for="title_desc" class="retro-btn filter-btn">Title (Z-A)</label>
                
                <input type="radio" name="sort_by" id="release_date_asc" value="release_date">
                <label for="release_date_asc" class="retro-btn filter-btn">Oldest First</label>
                
                <input type="radio" name="sort_by" id="release_date_desc" value="-release_date">
                <label for="release_date_desc" class="retro-btn filter-btn">Newest First</label>
              </div>
            </div>
          </div>
        </div>
      </form>      <!-- Content Display Area -->
      <div class="content-display">
        <!-- Continue Watching Section -->
        <div class="accordion-section">
          <div class="section-header" data-target="#continueWatching">
            <h3 class="section-title">
              <span class="chevron">â–¼</span> Continue Watching
              <span class="item-count" id="continueWatchingCount">({{ continue_watching|length }} items)</span>
            </h3>
          </div>
          <div id="continueWatching" class="section-content show">
            <div class="sunken-panel content-panel">
              <div class="content-grid" id="continueWatchingContent">                {% for item in continue_watching %}
                <div class="grid-item" data-media-id="{{ item.media_id }}">
                  <a href="{% if item.content_type_model == 'movie' %}{% url 'movie_page' item.media_tmdb_id %}{% else %}{% url 'tv_show_page' item.media_tmdb_id %}{% endif %}" class="item-link">
                    <div class="item-card">
                      {% if item.media_poster %}
                      <img src="{{ item.media_poster }}" class="item-poster" alt="{{ item.media_title }}">
                      {% else %}
                      <div class="item-poster no-image">
                        <span>No Image</span>
                      </div>
                      {% endif %}
                      <div class="item-body">
                        <h5 class="item-title">{{ item.media_title }}</h5>
                        <div class="item-meta">
                          {% if item.content_type_model == 'movie' %}
                          <span class="release-year">{{ item.media_release_date|date:"Y" }}</span>
                          {% else %}
                          <span class="release-year">{{ item.media_first_air_date|date:"Y" }}</span>
                          {% endif %}
                        </div>
                        
                        <!-- Progress Badge -->
                        <div class="progress-badge">{{ item.progress|floatformat:0 }}%</div>
                        
                        <!-- Average Rating Badge -->
                        {% if item.avg_rating %}
                        <div class="avg-rating-badge">
                          {{ item.avg_rating }} ({{ item.rating_count }})
                        </div>
                        {% endif %}
                        
                        <!-- Progress Bar -->
                        <div class="progress-bar-container">
                          <div class="progress-bar" style="width: {{ item.progress }}%"></div>
                        </div>
                      </div>
                      <button class="remove-item" data-id="{{ item.id }}">âœ•</button>
                    </div>
                  </a>
                </div>
                {% empty %}
                <div class="no-content-message">
                  <div class="message-content">
                    <div class="message-icon">ðŸ“º</div>
                    <div class="message-text">No shows in progress</div>
                  </div>
                </div>
                {% endfor %}
              </div>
            </div>
          </div>
        </div>        <!-- Haven't Started Section -->
        <div class="accordion-section">
          <div class="section-header" data-target="#haventStarted">
            <h3 class="section-title">
              <span class="chevron">â–¶</span> Haven't Started
              <span class="item-count" id="haventStartedCount">({{ havent_started|length }} items)</span>
            </h3>
          </div>
          <div id="haventStarted" class="section-content">
            <div class="sunken-panel content-panel">
              <div class="content-grid" id="haventStartedContent">
                {% for item in havent_started %}
                <div class="grid-item" data-media-id="{{ item.media_id }}">
                  <a href="{% if item.content_type_model == 'movie' %}{% url 'movie_page' item.media_tmdb_id %}{% else %}{% url 'tv_show_page' item.media_tmdb_id %}{% endif %}" class="item-link">
                    <div class="item-card">
                      {% if item.media_poster %}
                      <img src="{{ item.media_poster }}" class="item-poster" alt="{{ item.media_title }}">
                      {% else %}
                      <div class="item-poster no-image">
                        <span>No Image</span>
                      </div>
                      {% endif %}
                      <div class="item-body">
                        <h5 class="item-title">{{ item.media_title }}</h5>
                        <div class="item-meta">
                          {% if item.content_type_model == 'movie' %}
                          <span class="release-year">{{ item.media_release_date|date:"Y" }}</span>
                          {% else %}
                          <span class="release-year">{{ item.media_first_air_date|date:"Y" }}</span>
                          {% endif %}
                        </div>
                        
                        <!-- Average Rating Badge -->
                        {% if item.avg_rating %}
                        <div class="avg-rating-badge">
                          {{ item.avg_rating }} ({{ item.rating_count }})
                        </div>
                        {% endif %}
                      </div>
                      <button class="remove-item" data-id="{{ item.id }}">âœ•</button>
                    </div>
                  </a>
                </div>
                {% empty %}
                <div class="no-content-message">
                  <div class="message-content">
                    <div class="message-icon">ðŸ“º</div>
                    <div class="message-text">No unwatched TV shows in your list</div>
                  </div>
                </div>
                {% endfor %}
              </div>
            </div>
          </div>
        </div>        <!-- Finished Shows Section -->
        <div class="accordion-section">
          <div class="section-header" data-target="#finishedShows">
            <h3 class="section-title">
              <span class="chevron">â–¶</span> Finished Shows
              <span class="item-count" id="finishedShowsCount">({{ finished_shows|length }} items)</span>
            </h3>
          </div>
          <div id="finishedShows" class="section-content">
            <div class="sunken-panel content-panel">
              <div class="content-grid" id="finishedShowsContent">
                {% for item in finished_shows %}
                <div class="grid-item" data-media-id="{{ item.media_id }}">
                  <a href="{% url 'tv_show_page' item.media_tmdb_id %}" class="item-link">
                    <div class="item-card">
                      {% if item.media_poster %}
                      <img src="{{ item.media_poster }}" class="item-poster" alt="{{ item.media_title }}">
                      {% else %}
                      <div class="item-poster no-image">
                        <span>No Image</span>
                      </div>
                      {% endif %}
                      <div class="item-body">
                        <h5 class="item-title">{{ item.media_title }}</h5>
                        <div class="item-meta">
                          <span class="release-year">{{ item.media_first_air_date|date:"Y" }}</span>
                        </div>
                        
                        <!-- Completed Badge -->
                        <div class="completed-badge">Completed</div>
                        
                        <!-- Average Rating Badge -->
                        {% if item.avg_rating %}
                        <div class="avg-rating-badge">
                          {{ item.avg_rating }} ({{ item.rating_count }})
                        </div>
                        {% endif %}
                      </div>
                      <button class="remove-item" data-id="{{ item.id }}">âœ•</button>
                    </div>
                  </a>
                </div>
                {% empty %}
                <div class="no-content-message">
                  <div class="message-content">
                    <div class="message-icon">âœ…</div>
                    <div class="message-text">No completed shows in your list</div>
                  </div>
                </div>
                {% endfor %}
              </div>
            </div>
          </div>
        </div>
</div>
        <!-- Movies Section -->
        <div class="accordion-section">
          <div class="section-header" data-target="#movies">
            <h3 class="section-title">
              <span class="chevron">â–¶</span> Movies
              <span class="item-count" id="moviesCount">({{ movies|length }} items)</span>
            </h3>
          </div>
          <div id="movies" class="section-content">
            <div class="sunken-panel content-panel">
              <div class="content-grid" id="moviesContent">
                {% for item in movies %}
                <div class="grid-item" data-media-id="{{ item.media_id }}">
                  <a href="{% url 'movie_page' item.media_tmdb_id %}" class="item-link">
                    <div class="item-card">
                      {% if item.media_poster %}
                      <img src="{{ item.media_poster }}" class="item-poster" alt="{{ item.media_title }}">
                      {% else %}
                      <div class="item-poster no-image">
                        <span>No Image</span>
                      </div>
                      {% endif %}
                      <div class="item-body">
                        <h5 class="item-title">{{ item.media_title }}</h5>
                        <div class="item-meta">
                          <span class="release-year">{{ item.media_release_date|date:"Y" }}</span>
                        </div>
                        
                        <!-- Average Rating Badge -->
                        {% if item.avg_rating %}
                        <div class="avg-rating-badge">
                          {{ item.avg_rating }} ({{ item.rating_count }})
                        </div>
                        {% endif %}
                      </div>
                      <button class="remove-item" data-id="{{ item.id }}">âœ•</button>
                    </div>
                  </a>
                </div>
                {% empty %}
                <div class="no-content-message">
                  <div class="message-content">
                    <div class="message-icon">ðŸŽ¬</div>
                    <div class="message-text">No movies in your watchlist</div>
                  </div>
                </div>
                {% endfor %}
              </div>
            </div>
          </div>
        </div>
    </div>
    
    <!-- Status Bar -->
    <div class="status-bar">
      <div class="status-info">
        <span class="status-field">My Watchlist</span>
        <span class="status-separator">â€¢</span>
        <span class="status-field" id="totalItemsCount">{{ continue_watching|length|add:havent_started|length|add:finished_shows|length|add:movies|length }} items</span>
        <span class="status-separator" id="filterSeparator" style="display: none;">â€¢</span>
        <span class="status-field" id="filterStatus" style="display: none;"></span>
      </div>
    </div>
  </div>
  
  <!-- Fixed Filter Button at Bottom -->
  <div class="fixed-filter-container">
    <button class="retro-btn fixed-filters-btn" id="filtersBtn" onclick="toggleFilters()">
      ðŸ”§ Filters <span id="activeFiltersCount" style="display: none;"></span>
    </button>
  </div>
</div>

<style>
  /* Theme-adaptive CSS variables matching discover page */
  :root {
    --bg-color: #c0c0c0;
    --text-color: #000;
    --text-muted: #666;
    --border-dark: #808080;
    --border-light: #dfdfdf;
    --window-bg: #c0c0c0;
    --button-bg: #c0c0c0;
    --button-text: #000;
    --button-hover: #e0e0e0;
    --progress-bg: #fff;
    --progress-bar: #008080;
    --shadow-color: rgba(0,0,0,0.25);
    --poster-border: #a0a0a0;
    --explorer-bg: #ffffff;
    --folder-hover: #d0d1d5;
    --folder-active: #000080;
    --folder-active-text: #ffffff;
    --input-bg: #ffffff;
    --alert-bg: #e1e1e1;
    --tab-active: #ffffff;
    --tab-inactive: #e0e0e0;
  }

  @media (prefers-color-scheme: dark) {
    :root {
      --bg-color: #383838;
      --text-color: #ffffff;
      --text-muted: #b0b0b0;
      --border-dark: #2a2a2a;
      --border-light: #505050;
      --window-bg: #404040;
      --button-bg: #505050;
      --button-text: #ffffff;
      --button-hover: #606060;
      --progress-bg: #2a2a2a;
      --progress-bar: #00a0a0;
      --shadow-color: rgba(0,0,0,0.5);
      --poster-border: #606060;
      --explorer-bg: #2a2a2a;
      --folder-hover: #404040;
      --folder-active: #0060ff;
      --folder-active-text: #ffffff;
      --input-bg: #2a2a2a;
      --alert-bg: #404040;
      --tab-active: #2a2a2a;
      --tab-inactive: #383838;
    }
  }
  /* Page container - mobile-first approach */
  .watchlist-container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 10px;
    font-family: 'MS Sans Serif', sans-serif;
    overflow-x: hidden;
    box-sizing: border-box;
  }

  @media (min-width: 768px) {
    .watchlist-container {
      padding: 20px;
    }
  }

  /* Window structure styling */
  .window {
    border: 2px outset var(--bg-color);
    background-color: var(--bg-color);
    font-family: 'MS Sans Serif', sans-serif;
    box-shadow: 2px 2px 4px var(--shadow-color);
    margin-bottom: 20px;
  }

  .title-bar {
    background: linear-gradient(90deg, #0f0f81 0%, #1084d0 100%);
    color: white;
    padding: 2px;
    font-size: 11px;
    font-weight: bold;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  @media (prefers-color-scheme: dark) {
    .title-bar {
      background: linear-gradient(90deg, #1a1a3a 0%, #2060a0 100%);
    }
  }

  .title-bar-controls button {
    width: 16px;
    height: 14px;
    border: 1px outset var(--button-bg);
    background: var(--button-bg);
    margin-left: 2px;
    font-size: 8px;
    cursor: pointer;
  }

  .title-bar-controls button:active {
    border: 1px inset var(--button-bg);
  }

  .window-body {
    background-color: var(--window-bg);
    color: var(--text-color);
    padding: 8px;
    position: relative;
  }

  @media (min-width: 768px) {
    .window-body {
      padding: 12px;
    }
  }

  /* Status Bar */
  .status-bar {
    border-top: 1px solid var(--border-dark);
    background-color: var(--bg-color);
    padding: 4px 8px;
    font-size: 11px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 8px;
  }

  .status-info {
    display: flex;
    align-items: center;
    gap: 8px;
    flex-wrap: wrap;
  }
  .status-field {
    border: 1px inset var(--bg-color);
    padding: 2px 6px;
    background-color: var(--bg-color);
    color: var(--text-color);
    font-size: 10px;
  }

  .status-separator {
    color: var(--text-muted);
    font-size: 10px;
    margin: 0 2px;
  }

  #filterStatus {
    color: var(--text-muted);
    font-style: italic;
    max-width: 300px;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }

  #activeFiltersCount {
    background: #ff0000;
    color: white;
    border-radius: 8px;
    padding: 1px 4px;
    font-size: 8px;
    margin-left: 4px;
  }

  /* Filter Section - Windows 98 Style Window */
  .filter-form {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    z-index: 9999;
    min-width: 320px;
    max-width: 90vw;
  }

  .filter-form::before {
    content: '';
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.3);
    z-index: -1;
  }

  @media (max-width: 480px) {
    .filter-form {
      min-width: 280px;
      max-width: 95vw;
      top: 40%;
    }
  }

  /* Fixed Filter Button Container */
  .fixed-filter-container {
    position: fixed;
    bottom: 120px; /* Increased to be above navbar on all screen sizes */
    right: 20px;
    z-index: 9999;
    pointer-events: auto;
    display: block !important;
    visibility: visible !important;
  }

  .fixed-filters-btn {
    padding: 8px 16px !important;
    font-size: 12px !important;
    font-weight: bold;
    box-shadow: 2px 2px 4px var(--shadow-color);
    border: 2px outset var(--button-bg) !important;
    display: block !important;
    visibility: visible !important;
    opacity: 1 !important;
    background-color: var(--button-bg) !important;
    color: var(--button-text) !important;
  }

  .fixed-filters-btn:hover {
    background: var(--button-hover) !important;
  }

  .fixed-filters-btn:active {
    border: 2px inset var(--button-bg) !important;
    background: var(--button-bg) !important;
  }

  @media (max-width: 768px) {
    .fixed-filter-container {
      bottom: 100px;
      right: 15px;
    }
    
    .fixed-filters-btn {
      padding: 10px 14px !important;
      font-size: 11px !important;
    }
  }

  @media (min-width: 1024px) {
    .fixed-filter-container {
      bottom: 120px;
      right: 30px;
    }
    
    .fixed-filters-btn {
      padding: 10px 20px !important;
      font-size: 14px !important;
      box-shadow: 3px 3px 6px var(--shadow-color);
    }
  }

  .filter-group {
    display: block;
    margin-bottom: 15px;
  }

  .filter-group:last-child {
    margin-bottom: 0;
  }

  .filter-group label:first-child {
    display: block;
    margin-bottom: 5px;
    font-weight: bold;
  }

  .filter-group .btn-group {
    display: flex;
    gap: 2px;
    flex-wrap: wrap;
  }

  .filter-btn {
    font-size: 11px;
    min-width: 60px;
    margin-right: 4px;
    margin-bottom: 4px;
  }

  /* Address input styling for filters */
  .address-input {
    background-color: var(--input-bg);
    border: 1px inset var(--bg-color);
    color: var(--text-color);
    font-family: 'MS Sans Serif', sans-serif;
    font-size: 11px;
    padding: 2px 4px;
    width: 100%;
    box-sizing: border-box;
  }

  /* Content Display */
  .content-display {
    margin-top: 8px;
  }

  .accordion-section {
    margin-bottom: 20px;
  }

  .section-header {
    cursor: pointer;
    background-color: var(--button-bg);
    border: 2px outset var(--button-bg);
    padding: 6px 12px;
    margin-bottom: 0;
  }

  .section-header:hover {
    background-color: var(--button-hover);
  }

  .section-header:active {
    border: 2px inset var(--button-bg);
  }

  .section-title {
    font-family: 'MS Sans Serif', sans-serif;
    font-size: 14px;
    margin: 0;
    color: var(--text-color);
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .chevron {
    font-size: 12px;
    transition: transform 0.2s;
  }

  .section-header[aria-expanded="false"] .chevron {
    transform: rotate(-90deg);
  }

  .item-count {
    margin-left: auto;
    font-size: 11px;
    color: var(--text-muted);
  }
  .section-content {
    display: none;
    border: 2px inset var(--bg-color);
    border-top: none;
    padding: 8px;
    background-color: var(--explorer-bg);
    overflow: hidden;
    max-width: 100%;
    box-sizing: border-box;
  }

  .section-content.show {
    display: block;
  }
  /* Sunken panel for content */
  .sunken-panel {
    border: 2px inset var(--bg-color);
    background-color: var(--explorer-bg);
    color: var(--text-color);
    padding: 8px;
    overflow: hidden;
    max-width: 100%;
    box-sizing: border-box;
  }
  /* Content Grid - mobile-first responsive design */
  .content-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 8px;
    width: 100%;
    box-sizing: border-box;
    overflow: hidden;
    max-width: 100%;
  }

  @media (min-width: 480px) {
    .content-grid {
      grid-template-columns: repeat(3, 1fr);
      gap: 10px;
    }
  }

  @media (min-width: 768px) {
    .content-grid {
      grid-template-columns: repeat(4, 1fr);
      gap: 12px;
    }
  }

  @media (min-width: 1024px) {
    .content-grid {
      grid-template-columns: repeat(5, 1fr);
      gap: 15px;
    }
  }

  @media (min-width: 1200px) {
    .content-grid {
      grid-template-columns: repeat(6, 1fr);
    }
  }
  /* Grid items */
  .grid-item {
    position: relative;
    width: 100%;
    min-width: 0;
    overflow: hidden;
  }

  .item-link {
        text-decoration: none;
    color: inherit;
    display: block;
  }  .item-card {
    border: 1px solid var(--poster-border);
    background-color: var(--window-bg);
    height: 360px;
    display: flex;
    flex-direction: column;
    position: relative;
    overflow: hidden;
    border-radius: 0;
    font-family: 'MS Sans Serif', sans-serif;
    cursor: pointer;
    transition: all 0.2s ease;
    padding: 0;
    margin: 0;
    max-width: 100%;
    box-sizing: border-box;
  }
  .item-card:hover {
    border: 2px solid var(--button-hover);
    margin: -1px;
  }  .item-poster {
    height: 280px;
    object-fit: contain;
    display: block;
    background-color: var(--alert-bg);
    margin: 0;
    padding: 0;
  }

  .item-poster.no-image {
    background-color: var(--alert-bg);
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--text-muted);
    font-size: 11px;
  }

  .item-body {
    padding: 8px;
    background-color: var(--window-bg);
    color: var(--text-color);
    flex-grow: 1;
    display: flex;
    flex-direction: column;
  }

  .item-title {
    font-size: 11px;
    font-weight: bold;
    margin-bottom: 4px;
    line-height: 1.2;
    color: var(--text-color);
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }

  .item-meta {
    font-size: 10px;
    color: var(--text-muted);
    margin-bottom: 4px;
  }

  .release-year {
    font-weight: normal;
  }

  /* Rating badges */
  .avg-rating-badge {
    position: absolute;
    top: 8px;
    left: 8px;
    background-color: rgba(255, 193, 7, 0.9);
    color: #000;
    padding: 2px 6px;
    border-radius: 3px;
    font-size: 9px;
    font-weight: bold;
    z-index: 2;
  }

  .progress-badge {
    position: absolute;
    top: 8px;
    right: 8px;
    background: rgba(0, 128, 0, 0.7);
    color: white;
    padding: 2px 6px;
    font-size: 9px;
    border-radius: 3px;
    font-weight: bold;
    z-index: 2;
  }

  .completed-badge {
    position: absolute;
    top: 8px;
    right: 8px;
    background: rgba(0, 128, 0, 0.7);
    color: white;
    padding: 2px 6px;
    font-size: 9px;
    border-radius: 3px;
    font-weight: bold;
    z-index: 2;
  }

  /* Progress bar for continue watching */
  .progress-bar-container {
    width: 100%;
    height: 4px;
    background-color: var(--progress-bg);
    border: 1px inset var(--bg-color);
    margin-top: 4px;
    overflow: hidden;
  }

  .progress-bar {
    height: 100%;
    background-color: var(--progress-bar);
    transition: width 0.3s ease;
  }  /* Remove item button */
  .remove-item {
    position: absolute;
    top: -1px;
    right: -1px;
    background: #ff4444 !important;
    color: white !important;
    border: 1px outset #ff4444 !important;
    width: 18px !important;
    height: 18px !important;
    min-width: 18px !important;
    min-height: 18px !important;
    font-size: 10px !important;
    cursor: pointer;
    z-index: 3;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 0 !important;
    box-shadow: none !important;
    text-shadow: none !important;
    border-radius: 0 !important;
  }
  .remove-item:hover {
    background: #ff6666 !important;
  }

  .remove-item:active {
    border: 1px inset #ff4444 !important;
  }

  /* No content message */
  .no-content-message {
    grid-column: 1 / -1;
    text-align: center;
    padding: 40px 20px;
    color: var(--text-muted);
  }

  .message-content {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 8px;
  }

  .message-icon {
    font-size: 24px;
    opacity: 0.7;
  }

  .message-text {
    font-size: 12px;
    font-weight: bold;
  }

  .message-subtext {
    font-size: 10px;
    opacity: 0.8;
  }

  /* Retro button styling */
  .retro-btn {
    border: 1px outset var(--button-bg);
    background: var(--button-bg);
    color: var(--button-text);
    padding: 2px 8px;
    font-family: 'MS Sans Serif', sans-serif;
    font-size: 11px;
    cursor: pointer;
    text-decoration: none;
    display: inline-block;
    transition: background-color 0.1s ease;
  }

  .retro-btn:hover {
    background: var(--button-hover);
    color: var(--button-text);
    text-decoration: none;
  }

  .retro-btn:active {
    border: 1px inset var(--button-bg);
  }  /* Mobile responsive adjustments */
  @media (max-width: 576px) {
    .item-card {
      height: 290px;
    }
    
    .item-poster {
      height: 220px;
    }
    
    .item-title {
      font-size: 10px;
    }
    
    .item-meta {
      font-size: 9px;
    }
      .avg-rating-badge, .progress-badge, .completed-badge {
      font-size: 13px;
      padding: 2px 5px;
    }
    
    .remove-item {
      width: 20px !important;
      height: 20px !important;
      min-width: 20px !important;
      min-height: 20px !important;
      font-size: 10px !important;
      top: -1px;
      right: -1px;
    }
    
    .progress-badge, .completed-badge {
      top: 25px !important;
      right: 8px !important;
    }
  }
</style>

<script>
  // Simple toggleFilters function
  function toggleFilters() {
    const filterForm = document.getElementById('filterForm');
    if (filterForm.style.display === 'none' || filterForm.style.display === '') {
      filterForm.style.display = 'block';
    } else {
      filterForm.style.display = 'none';
    }
  }

  document.addEventListener('DOMContentLoaded', function() {
    // Accordion functionality
    const headers = document.querySelectorAll('.section-header');
    headers.forEach(header => {
      header.addEventListener('click', function() {
        const target = document.querySelector(this.dataset.target);
        if (target.classList.contains('show')) {
          target.classList.remove('show');
          this.querySelector('.chevron').textContent = 'â–¶';
        } else {
          target.classList.add('show');
          this.querySelector('.chevron').textContent = 'â–¼';
        }
      });
    });      // Filter modal functionality
    const filterForm = document.getElementById('filterForm');
    
    // AJAX search and filtering
    let searchTimer;
    const searchInput = document.getElementById('searchInput');
    const genreFilter = document.getElementById('genreFilter');
    const countryFilter = document.getElementById('countryFilter');    const sortByRadios = document.querySelectorAll('input[name="sort_by"]');    // Update total count in status bar
    function updateTotalCount() {
        const totalCountElement = document.getElementById('totalItemsCount');
        if (!totalCountElement) return;
        
        // Count all items across all sections
        const continueWatchingItems = document.querySelectorAll('#continueWatchingContent .grid-item').length;
        const haventStartedItems = document.querySelectorAll('#haventStartedContent .grid-item').length;
        const finishedShowsItems = document.querySelectorAll('#finishedShowsContent .grid-item').length;
        const moviesItems = document.querySelectorAll('#moviesContent .grid-item').length;
        
        const totalItems = continueWatchingItems + haventStartedItems + finishedShowsItems + moviesItems;
        totalCountElement.textContent = `${totalItems} item${totalItems !== 1 ? 's' : ''}`;
    }

    // Update active filters count and status description
    function updateActiveFiltersCount() {
        const filterForm = document.getElementById('filterForm');
        const activeFiltersSpan = document.getElementById('activeFiltersCount');
        const filterStatus = document.getElementById('filterStatus');
        const filterSeparator = document.getElementById('filterSeparator');
        
        if (!filterForm || !activeFiltersSpan) return;
        
        let activeCount = 0;
        let filterDescriptions = [];
        
        // Check search input
        const searchInput = document.getElementById('searchInput');
        if (searchInput && searchInput.value.trim() !== '') {
            activeCount++;
            filterDescriptions.push(`Search: "${searchInput.value.trim()}"`);
        }
        
        // Check genre filter
        const genreFilter = document.getElementById('genreFilter');
        if (genreFilter && genreFilter.value !== '') {
            activeCount++;
            const selectedOption = genreFilter.options[genreFilter.selectedIndex];
            filterDescriptions.push(`Genre: ${selectedOption.text}`);
        }
        
        // Check country filter
        const countryFilter = document.getElementById('countryFilter');
        if (countryFilter && countryFilter.value !== '') {
            activeCount++;
            const selectedOption = countryFilter.options[countryFilter.selectedIndex];
            filterDescriptions.push(`Country: ${selectedOption.text}`);
        }
        
        // Check sort radio buttons (if not default)
        const sortByRadios = document.querySelectorAll('input[name="sort_by"]:checked');
        if (sortByRadios.length > 0 && sortByRadios[0].value !== 'date_added') {
            activeCount++;
            const sortLabels = {
                'title': 'Title A-Z',
                'title_desc': 'Title Z-A',
                'release_date': 'Release Date',
                'release_date_desc': 'Release Date (Newest)',
                'date_added': 'Date Added',
                'rating': 'Rating'
            };
            filterDescriptions.push(`Sorted by: ${sortLabels[sortByRadios[0].value] || sortByRadios[0].value}`);
        }
        
        // Update filter button count
        if (activeCount > 0) {
            activeFiltersSpan.textContent = ` (${activeCount})`;
            activeFiltersSpan.style.display = 'inline';
        } else {
            activeFiltersSpan.style.display = 'none';
        }
        
        // Update status bar filter description
        if (filterDescriptions.length > 0 && filterStatus && filterSeparator) {
            filterStatus.textContent = filterDescriptions.join(', ');
            filterStatus.style.display = 'inline';
            filterSeparator.style.display = 'inline';
        } else if (filterStatus && filterSeparator) {
            filterStatus.style.display = 'none';
            filterSeparator.style.display = 'none';
        }
    }// Close filter modal when clicking outside
    document.addEventListener('click', function(e) {
      if (!filterForm.contains(e.target) && !e.target.closest('.fixed-filters-btn')) {
        filterForm.style.display = 'none';
      }
    });

    function updateWatchlist() {
      const searchQuery = searchInput.value;
      const genre = genreFilter.value;
      const country = countryFilter.value;
      
      // Get selected sort option from radio buttons
      let sort = 'date_added';
      sortByRadios.forEach(radio => {
        if (radio.checked) {
          sort = radio.value;
        }
      });
        fetch(`/api/watchlist/?search=${searchQuery}&genre=${genre}&country=${country}&sort_by=${sort}`)
        .then(response => response.json())
        .then(data => {
          // Update continue watching section
          updateSection('continueWatching', data.continue_watching);
          document.getElementById('continueWatchingCount').textContent = data.continue_watching.length;
          
          // Update haven't started section
          updateSection('haventStarted', data.havent_started);
          document.getElementById('haventStartedCount').textContent = data.havent_started.length;

          updateSection('finishedShows', data.finished_shows);
          document.getElementById('finishedShowsCount').textContent = data.finished_shows.length;
          // Update movies section
          updateSection('movies', data.movies);
          document.getElementById('moviesCount').textContent = data.movies.length;
          
          // Update status bar total count
          updateTotalCount();
          // Update filter descriptions in status bar
          updateActiveFiltersCount();
        })
        .catch(error => console.error('Error updating watchlist:', error));
    }
      function updateSection(sectionId, items) {
      const contentDiv = document.getElementById(sectionId + 'Content');
      
      if (items.length === 0) {
        contentDiv.innerHTML = `
          <div class="no-content-message">
            <div class="message-content">
              <div class="message-icon">ðŸ“º</div>
              <div class="message-text">No items found</div>
              <div class="message-subtext">Try adjusting your filters</div>
            </div>
          </div>
        `;
        return;
      }
      
      let html = '';
      items.forEach(item => {
        let itemHtml = '';
        if (item.item && 'progress' in item) {
          // Continue watching item
          itemHtml = createItemHtml(item.item, item.progress);
        } else {
          // Regular item (movies, havent_started, finished_shows)
          itemHtml = createItemHtml(item);
        }
        html += itemHtml;
      });
      
      contentDiv.innerHTML = html;
      
      // Re-attach event listeners to remove buttons
      document.querySelectorAll('.remove-item').forEach(btn => {
        btn.addEventListener('click', removeFromWatchlist);
      });
    }      function createItemHtml(item, progress = null) {
      const isMovie = item.content_type_model === 'movie';
      const detailUrl = isMovie ? 
        `/movies/${item.media_tmdb_id}/` : 
        `/tvshows/${item.media_tmdb_id}/`;
      
      const dateDisplay = isMovie ? 
        formatDate(item.media_release_date) : 
        formatDate(item.media_first_air_date);
      
      // Progress badge for the top-right corner
      const progressBadge = progress !== null ? `
        <div class="progress-badge">${Math.round(progress)}%</div>
      ` : '';
      
      // Progress bar for under the title
      const progressBar = progress !== null ? `
        <div class="progress-bar-container">
          <div class="progress-bar" style="width: ${progress}%"></div>
        </div>
      ` : '';
      
      // Average Rating badge - should always be shown if available
      const ratingHtml = item.avg_rating ? `
        <div class="avg-rating-badge">
          ${item.avg_rating} (${item.rating_count})
        </div>
      ` : '';
      
      // Completed badge for finished shows
      const completedBadge = item.content_type_model === 'tvshow' && progress >= 100 ? `
        <div class="completed-badge">Completed</div>
      ` : '';
      
      return `
        <div class="grid-item" data-media-id="${item.media_id}">
          <a href="${detailUrl}" class="item-link">
            <div class="item-card">
              ${item.media_poster ? 
                `<img src="${item.media_poster}" class="item-poster" alt="${item.media_title}">` : 
                `<div class="item-poster no-image">
                  <span>No Image</span>
                </div>`
              }
              <div class="item-body">
                <h5 class="item-title">${item.media_title}</h5>
                <div class="item-meta">
                  <span class="release-year">${dateDisplay}</span>
                </div>
                
                ${progressBadge}
                ${ratingHtml}
                ${progressBar}
              </div>
              <button class="remove-item" data-id="${item.id}" title="Remove from watchlist">âœ•</button>
            </div>
          </a>
        </div>
      `;
    }
    
    function formatDate(dateString) {
      if (!dateString) return '';
      return new Date(dateString).getFullYear();
    }
    
    function formatTimeSince(dateString) {
      // Simple function to approximate time since
      const date = new Date(dateString);
      const now = new Date();
      const seconds = Math.floor((now - date) / 1000);
      
      let interval = Math.floor(seconds / 31536000);
      if (interval >= 1) return interval + " year" + (interval === 1 ? "" : "s");
      
      interval = Math.floor(seconds / 2592000);
      if (interval >= 1) return interval + " month" + (interval === 1 ? "" : "s");
      
      interval = Math.floor(seconds / 86400);
      if (interval >= 1) return interval + " day" + (interval === 1 ? "" : "s");
      
      interval = Math.floor(seconds / 3600);
      if (interval >= 1) return interval + " hour" + (interval === 1 ? "" : "s");
      
      interval = Math.floor(seconds / 60);
      if (interval >= 1) return interval + " minute" + (interval === 1 ? "" : "s");
      
      return Math.floor(seconds) + " second" + (seconds === 1 ? "" : "s");
    }      function removeFromWatchlist(event) {
      event.preventDefault();
      const itemId = event.target.dataset.id;
      const itemElement = event.target.closest('.grid-item');
      const mediaTitle = itemElement.querySelector('.item-title').textContent.trim();
      
      // Show confirmation dialog
      if (!confirm(`Are you sure you want to remove "${mediaTitle}" from your watchlist?`)) {
        return; // User canceled the action
      }
      
      fetch('/api/watchlist/remove/', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({
          item_id: itemId
        })
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          // Remove the item from the DOM with a fade-out effect
          itemElement.style.transition = 'opacity 0.3s ease';
          itemElement.style.opacity = '0';          setTimeout(() => {
            itemElement.remove();
            // Update counts
            updateWatchlist();
            updateTotalCount();
          }, 300);
        } else {
          alert("Error removing item: " + data.error);
        }
      })
      .catch(error => console.error('Error removing watchlist item:', error));
    }
    
    function getCookie(name) {
      let cookieValue = null;
      if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
          const cookie = cookies[i].trim();
          if (cookie.substring(0, name.length + 1) === (name + '=')) {
            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
            break;
          }
        }
      }
      return cookieValue;
    }    // Set up event listeners for filters
    searchInput.addEventListener('input', function() {
      clearTimeout(searchTimer);
      searchTimer = setTimeout(updateWatchlist, 500);
      updateActiveFiltersCount(); // Update filter count when search changes
    });
    
    genreFilter.addEventListener('change', function() {
      updateWatchlist();
      updateActiveFiltersCount(); // Update filter count when genre changes
    });
    
    countryFilter.addEventListener('change', function() {
      updateWatchlist();
      updateActiveFiltersCount(); // Update filter count when country changes
    });
    
    // Add event listeners for sort radio buttons
    sortByRadios.forEach(radio => {
      radio.addEventListener('change', function() {
        updateWatchlist();
        updateActiveFiltersCount(); // Update filter count when sort changes
      });    });
    
    // Filter button click handlers (make labels clickable)
    const filterButtons = document.querySelectorAll('.filter-btn');
    filterButtons.forEach(button => {
        button.addEventListener('click', function(e) {
            e.preventDefault();
            const radioId = this.getAttribute('for');
            const radio = document.getElementById(radioId);
            if (radio) {
                radio.checked = true;
                radio.dispatchEvent(new Event('change'));
            }
        });
        
        // Keyboard support
        button.addEventListener('keydown', function(e) {
            if (e.key === 'Enter' || e.key === ' ') {
                e.preventDefault();
                this.click();
            }
        });
    });
    
    // Add visual feedback for button interactions
    const allButtons = document.querySelectorAll('.retro-btn, .filter-btn');
    allButtons.forEach(button => {
        button.addEventListener('mousedown', function() {
            this.style.border = '1px inset var(--button-bg)';
        });
        
        button.addEventListener('mouseup', function() {
            this.style.border = '1px outset var(--button-bg)';
        });
        
        button.addEventListener('mouseleave', function() {
            this.style.border = '1px outset var(--button-bg)';
        });
    });    // Attach event listeners to remove buttons
    document.querySelectorAll('.remove-item').forEach(btn => {
      btn.addEventListener('click', removeFromWatchlist);
    });
    
    // Initialize status bar counts and filters
    updateTotalCount();
    updateActiveFiltersCount();
  });
</script>
{% endblock %}