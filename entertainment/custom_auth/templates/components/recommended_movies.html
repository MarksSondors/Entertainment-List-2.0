{% load static %}

<!-- Recommended Content Component -->
<div class="window" style="width: 100%;">
    <div class="title-bar">
        <div class="title-bar-text">Recommended For You</div>
        <div class="title-bar-controls">
            <button aria-label="Minimize"></button>
            <button aria-label="Maximize"></button>
            <button aria-label="Close"></button>
        </div>
    </div>
    
    <!-- Tabs -->
    <div class="window-body" style="padding: 8px 8px 0 8px; background-color: var(--win98-gray);">
        <div class="tabs-row">
            <button class="tab-btn active" onclick="loadRecommendations('movies', this)" data-tab="movies">Movies</button>
            <button class="tab-btn" onclick="loadRecommendations('tvshows', this)" data-tab="tvshows">TV Shows</button>
            <button class="tab-btn" onclick="loadRecommendations('games', this)" data-tab="games">Games</button>
            <!-- Separator -->
            <div style="width: 10px;"></div>
            <button class="tab-btn" onclick="loadRecommendations('external', this)" data-tab="external">
                <img src="{% static 'images/win98/world.png' %}" alt="" style="width: 12px; height: 12px; vertical-align: text-bottom; margin-right: 2px;">
                Discover
            </button>
        </div>
    </div>

    <div class="window-body" style="padding: 0 8px 8px 8px; background-color: var(--win98-gray);">
        <div class="tab-content-container">
            <div class="scrollable-row" id="recommendations_container">
                <div class="poster-item" style="width: 100%; height: 200px;">
                    <div class="poster-card" style="display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 10px; height: 100%; width: 100%;">
                        <img src="{% static 'images/loading-recommendations.gif' %}" alt="Loading..." style="width: 160px; height: 160px; margin-bottom: 10px;">
                        <span>Loading recommendations...</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="status-bar">
        <div class="status-bar-field" id="rec_status_text">Based on your ratings across all media</div>
    </div>
</div>

<style>
    .tmdb-add-button {
        width: 100%;
        padding: 4px;
        background-color: #4CAF50;
        color: white;
        border: 1px outset #4CAF50;
        cursor: pointer;
        font-weight: bold;
        font-size: 11px;
        text-align: center;
        box-shadow: 1px 1px 2px rgba(0,0,0,0.3);
        z-index: 10;
        position: relative; /* Ensure it's clickable */
    }

    .tmdb-add-button:hover {
        background-color: #45a049;
    }

    .tmdb-add-button:active {
        border: 1px inset #4CAF50;
    }

    .tmdb-add-button:disabled {
        background-color: #cccccc;
        color: #666666;
        border: 1px solid #999;
        cursor: not-allowed;
    }

    .video-poster-wrapper {
        position: relative;
        width: 100%;
        height: 100%;
    }

    .tabs-row {
        display: flex;
        flex-wrap: wrap;
        gap: 2px;
        margin-bottom: -2px; /* Overlap with content border */
        position: relative;
        z-index: 1;
    }

    .tab-btn {
        flex: 1;
        min-width: 80px;
        padding: 4px 8px;
        background: var(--win98-gray);
        color: var(--win98-text);
        border-top: 1.5px solid var(--win98-light);
        border-left: 1.5px solid var(--win98-light);
        border-right: 1.5px solid var(--win98-dark);
        border-bottom: 1.5px solid var(--win98-dark);
        border-radius: 4px 4px 0 0;
        font-family: inherit;
        font-size: 12px;
        cursor: pointer;
        position: relative;
        margin-top: 2px;
    }

    .tab-btn:active {
        padding: 5px 7px 3px 9px; /* Shift text on click */
    }

    .tab-btn.active {
        border-bottom: 1.5px solid var(--win98-gray); /* Blend with content */
        margin-top: 0;
        padding-bottom: 6px; /* Extend down */
        padding-top: 6px;
        z-index: 2;
        font-weight: bold;
    }

    .tab-content-container {
        border-top: 1.5px solid var(--win98-light);
        border-left: 1.5px solid var(--win98-light);
        border-right: 1.5px solid var(--win98-dark);
        border-bottom: 1.5px solid var(--win98-dark);
        background: var(--win98-gray);
        padding: 8px;
        box-shadow: 1px 1px 0 var(--win98-black); /* Outer shadow */
        position: relative;
        z-index: 0;
    }

    /* Mobile responsiveness */
    @media (max-width: 600px) {
        .tabs-row {
            flex-wrap: nowrap;
            overflow-x: auto;
            padding-bottom: 0;
            -webkit-overflow-scrolling: touch;
            /* Hide scrollbar */
            scrollbar-width: none; 
            -ms-overflow-style: none;
        }
        .tabs-row::-webkit-scrollbar { 
            display: none; 
        }
        
        .tab-btn {
            flex: 0 0 auto; /* Don't shrink */
            min-width: auto;
            padding: 4px 12px;
        }
    }
</style>

<script>
    // Cache for recommendations to avoid refetching
    const recCache = {};

    function loadRecommendations(type, btnElement) {
        // Update tabs
        if (btnElement) {
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            btnElement.classList.add('active');
        }

        const container = document.getElementById('recommendations_container');
        const statusText = document.getElementById('rec_status_text');
        
        // Update status text
        if (type === 'combined') statusText.textContent = 'Based on your ratings across all media';
        else if (type === 'movies') statusText.textContent = 'Based on your movie ratings';
        else if (type === 'tvshows') statusText.textContent = 'Based on your TV show ratings';
        else if (type === 'games') statusText.textContent = 'Based on your game ratings';
        else if (type === 'external') statusText.textContent = 'Personalized picks from TMDB. These movies are not in your library yet.';

        // Check cache
        if (recCache[type]) {
            renderRecommendations(recCache[type], type);
            return;
        }

        // Show loading
        container.innerHTML = `
            <div class="poster-item" style="width: 100%; height: 200px;">
                <div class="poster-card" style="display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 10px; height: 100%; width: 100%;">
                    <img src="{% static 'images/loading-recommendations.gif' %}" alt="Loading..." style="width: 160px; height: 160px; margin-bottom: 10px;">
                    <span>Loading recommendations...</span>
                </div>
            </div>
        `;

        // Determine endpoint
        let endpoint = '';
        if (type === 'combined') endpoint = '/api/recommendations/combined/';
        else if (type === 'movies') endpoint = '/movies/recommendations/';
        else if (type === 'tvshows') endpoint = '/tvshows/recommendations/';
        else if (type === 'games') endpoint = '/games/recommendations/';
        else if (type === 'external') endpoint = '/movies/recommendations/external/';

        fetch(endpoint)
            .then(response => response.json())
            .then(data => {
                recCache[type] = data;
                renderRecommendations(data, type);
            })
            .catch(error => {
                console.error(`Error fetching ${type} recommendations:`, error);
                container.innerHTML = '<div class="poster-item"><div class="poster-card" style="padding: 20px; text-align: center; height: 120px; display: flex; align-items: center; justify-content: center;">Failed to load recommendations.</div></div>';
            });
    }

    function renderRecommendations(data, type) {
        const container = document.getElementById('recommendations_container');
        container.innerHTML = '';

        if (data.length === 0) {
            container.innerHTML = '<div class="poster-item"><div class="poster-card" style="padding: 20px; text-align: center; height: 120px; display: flex; align-items: center; justify-content: center;">No recommendations yet. Rate more content to get personalized suggestions!</div></div>';
            return;
        }

        data.slice(0, 15).forEach(item => {
            const el = document.createElement('div');
            el.className = 'poster-item';
            
            let url = '';
            let poster = item.poster;
            let title = item.title;
            let rating = item.rating;
            let predictedRating = item.predicted_rating ? Number(item.predicted_rating).toFixed(1) : null;
            let mediaTypeLabel = '';

            // Handle structure differences for external TMDB results
            if (type === 'external') {
                // External items come from TMDB directly
                if (item.poster_path) {
                    poster = `https://image.tmdb.org/t/p/w342${item.poster_path}`;
                } else {
                    poster = null;
                }
                rating = item.vote_average ? Math.round(item.vote_average * 10) / 10 : null;
            }

            if (type === 'combined') {
                url = item.url;
                // Add media type badge for combined view
                if (item.media_type === 'movies') mediaTypeLabel = 'ðŸŽ¬ Movie';
                else if (item.media_type === 'tvshows') mediaTypeLabel = 'ðŸ“º TV';
                else if (item.media_type === 'games') mediaTypeLabel = 'ðŸŽ® Game';
            } else if (type === 'movies') {
                url = `/movies/${item.tmdb_id}/`;
            } else if (type === 'tvshows') {
                url = `/tvshows/${item.tmdb_id}/`;
            } else if (type === 'games') {
                url = `/games/${item.id}/`;
            } else if (type === 'external') {
                // Link to create/view movie page by TMDB ID
                // The backend creates it if missing when accessed via /movies/<tmdb_id>/
                url = `/movies/${item.id}/`;
            }

            // Fallback poster
            if (!poster) poster = '{% static "images/no-poster.png" %}';

            el.innerHTML = `
                <div class="poster-card" style="display: flex; flex-direction: column; height: 100%;">
                    <a href="${url}" style="text-decoration:none; color:inherit; display:block; flex-grow: 1; position: relative;">
                        <img src="${poster}" alt="${title}" style="height: 100%; width: 100%; object-fit: cover;">
                        <div class="info-overlay">
                            <div class="title">${title}</div>
                            <div class="rating">
                                ${rating ? 'TMDB: ' + rating : 'N/A'}
                                ${predictedRating ? `<br><span style="background-color: var(--button-highlight); color: white; padding: 1px 4px; border-radius: 3px; font-size: 0.9em;">For You: ${predictedRating}</span>` : ''}
                                ${mediaTypeLabel ? `<br><span style="font-size:0.8em; opacity:0.8">${mediaTypeLabel}</span>` : ''}
                            </div>
                        </div>
                    </a>
                    ${type === 'external' ? `
                        <button onclick="addToWatchlist(event, ${item.id}, this)" class="tmdb-add-button">
                            + Watchlist
                        </button>
                    ` : ''}
                </div>
            `;
            container.appendChild(el);
        });
    }

    function addToWatchlist(event, tmdbId, btn) {
        event.preventDefault();
        event.stopPropagation();
        
        btn.disabled = true;
        btn.textContent = 'Adding...';
        
        fetch('/movies/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({
                id: tmdbId,
                add_to_watchlist: true
            })
        })
        .then(response => {
            if (response.ok) {
                btn.textContent = 'âœ“ Added';
                btn.disabled = true;
                // Remove from local recommendations cache to update state if reloaded?
                // Or just leave it marked as added.
            } else {
                btn.textContent = 'Error';
                btn.disabled = false;
            }
        })
        .catch(error => {
            console.error('Error adding to watchlist:', error);
            btn.textContent = 'Error';
            btn.disabled = false;
        });
    }

    // CSRF Token Helper
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    // Initial load
    document.addEventListener('DOMContentLoaded', () => {
        loadRecommendations('movies', document.querySelector('.tab-btn[data-tab="movies"]'));
    });
</script>