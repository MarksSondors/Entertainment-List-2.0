{% load static %}
{% comment %} movie_search_component.html - Standalone movie search modal component {% endcomment %}

<div id="movie-search-modal" class="modal" style="display: none;">
    <div class="modal-content window" style="width: 80%; max-width: 800px; max-height: 90vh; display: flex; flex-direction: column;">
        <!-- Modal Header -->
        <div class="title-bar">
            <div class="title-bar-text" id="modal-title">Add Movie</div>
            <div class="title-bar-controls">
                <button aria-label="Close" id="close-modal-btn"></button>
            </div>
        </div>
    <!-- Modal Body -->
    <div class="window-body" style="overflow-y: auto; flex: 1; display: flex; flex-direction: column;">
    <!-- Stage 1: Search and Select -->
    <div id="modal-stage-1" style="display: flex; flex-direction: column; height: 100%;">
        <!-- Search Input -->
        <div class="field-row" style="margin-bottom: 10px;">
            <label for="query">Search:</label>
            <input type="text" id="query" name="query" style="flex-grow: 1;" placeholder="Enter movie title">
            <button id="search-button">Search</button>
        </div>
        
        <!-- Results Section -->
        <div class="sunken-panel" style="flex: 1; overflow-y: auto; background-color: var(--input-bg); margin-bottom: 10px; padding: 0;">
            <ul id="results-list" class="tree-view" style="height: 100%; width: 100%; border: none; margin: 0;"></ul>
        </div>
        
        <div id="loading-more" style="text-align: center; padding: 5px; display: none;">
            <p style="margin: 0;">Loading more results...</p>
        </div>
        
        <!-- Status Bar & Navigation -->
        <div style="display: flex; justify-content: space-between; align-items: center; margin-top: auto;">
            <div class="status-bar-field" style="flex: 1; margin-right: 10px;">
                Total Results: <span id="total-results">0</span>
            </div>
            
            <div style="display: flex; align-items: center; gap: 10px;">
                <div id="movie-selection-hint" style="color: var(--text-muted); font-style: italic; display: none; font-size: 11px;">
                    Select a movie to continue
                </div>
                <button id="to-stage-2-btn" disabled style="min-width: 80px;">Next &gt;</button>
            </div>
        </div>
    </div>

    <!-- Stage 2: Edit Movie Details -->
    <div id="modal-stage-2" style="display: none; flex-direction: column; height: 100%;">
        <form method="post" id="add-movie-form" enctype="multipart/form-data" style="display: flex; flex-direction: column; height: 100%;">
            {% csrf_token %}
            <input type="hidden" id="tmdb_id" name="tmdb_id">
            
            <!-- Tabs -->
            <menu role="tablist" style="margin-bottom: 0;">
                <li role="tab" aria-selected="true" id="tab-general"><a href="#general">General</a></li>
                <li role="tab" aria-selected="false" id="tab-images"><a href="#images">Images</a></li>
            </menu>
            
            <div class="window" role="tabpanel" style="flex: 1; margin: 0; border-top: none; padding: 12px; overflow-y: auto;">
                <!-- General Tab Content -->
                <div id="tab-content-general">
                    <div class="field-row" style="margin-bottom: 10px;">
                        <label style="width: 80px;">Title:</label>
                        <input type="text" id="title-display" readonly style="flex: 1;">
                        <input type="hidden" id="title-hidden" name="title">
                    </div>
                    
                    <div class="field-row" style="margin-bottom: 10px;">
                        <label style="width: 80px;">Release Date:</label>
                        <input type="text" id="release_date-display" readonly style="width: 120px;">
                        <input type="hidden" id="release_date-hidden" name="release_date">
                    </div>
                    
                    <div class="field-row-stacked" style="margin-bottom: 15px;">
                        <label>Description:</label>
                        <textarea id="description-display" readonly style="height: 100px; width: 100%; resize: vertical; font-family: inherit;"></textarea>
                        <input type="hidden" id="description-hidden" name="description">
                    </div>
                    
                    <fieldset style="margin-bottom: 10px;">
                        <legend>Options</legend>
                        <div class="field-row">
                            <input type="checkbox" id="is_anime" name="is_anime">
                            <label for="is_anime">This is an anime movie</label>
                        </div>
                        <div class="field-row">
                            <input type="checkbox" id="add_to_watchlist" name="add_to_watchlist" checked>
                            <label for="add_to_watchlist">Add to my watchlist</label>
                        </div>
                    </fieldset>
                </div>
                
                <!-- Images Tab Content -->
                <div id="tab-content-images" style="display: none;">
                    <div style="display: flex; gap: 20px; height: 100%;">
                        <div style="flex: 1; display: flex; flex-direction: column; align-items: center;">
                            <h4 style="margin-top: 0;">Poster</h4>
                            <div class="sunken-panel" style="padding: 10px; background: var(--poster-bg); margin-bottom: 10px; display: flex; justify-content: center; align-items: center; width: 100%; height: 250px;">
                                <img id="movie-poster-preview" src="" alt="Movie poster" style="max-width: 100%; max-height: 100%; object-fit: contain; cursor: pointer;" onclick="openPosterSelectionModal()">
                            </div>
                            <button type="button" onclick="openPosterSelectionModal()" style="width: 100%;">Browse Posters...</button>
                            <input type="hidden" id="default-poster-path" name="default_poster_path">
                        </div>
                        
                        <div style="flex: 1; display: flex; flex-direction: column; align-items: center;">
                            <h4 style="margin-top: 0;">Backdrop</h4>
                            <div class="sunken-panel" style="padding: 10px; background: var(--poster-bg); margin-bottom: 10px; display: flex; justify-content: center; align-items: center; width: 100%; height: 250px;">
                                <img id="movie-backdrop-preview" src="" alt="Movie backdrop" style="max-width: 100%; max-height: 100%; object-fit: contain; cursor: pointer;" onclick="openBackdropSelectionModal()">
                            </div>
                            <button type="button" onclick="openBackdropSelectionModal()" style="width: 100%;">Browse Backdrops...</button>
                            <input type="hidden" id="default-backdrop-path" name="default_backdrop_path">
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Navigation Buttons -->
            <div style="display: flex; justify-content: space-between; margin-top: 15px;">
                <button type="button" id="back-to-stage-1-btn">&lt; Back</button>
                <button type="button" id="submit-movie-btn" style="font-weight: bold;">Finish</button>
            </div>
        </form>
    </div>
    </div>
    </div>
</div>

<!-- Update the loading screen modal for task status info -->
<div id="loading-screen-modal" class="modal" style="display: none; z-index: 1200;">
    <div class="modal-content window" style="width: 400px;">
        <div class="title-bar">
            <div class="title-bar-text">Adding Movie</div>
        </div>
        <div class="window-body" style="text-align: center; padding: 20px;">
            <p id="movie-loading-message">Adding movie to your list...</p>
            <div class="progress-indicator">
                <span class="progress-indicator-bar"></span>
            </div>            <div id="movie-task-info" style="margin-top: 15px; font-size: 12px; display: none;">
                <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; margin-bottom: 10px;">
                    <img src="{% static 'images/handshake.gif' %}" alt="Handshake" style="width: 100px; height: 100px; margin-bottom: 10px;">
                    <p style="margin: 0; text-align: center;">This may take some time. You can close this dialog and the process will continue in the background.</p>
                </div>
                <p>Your movie will be available in your library once the process completes.</p>
                <button id="movie-close-loading-btn">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Add success/error message dialog -->
<div id="message-dialog" class="modal" style="display: none; z-index: 1200;">
<div class="modal-content window" style="width: 400px;">
<div class="title-bar">
<div class="title-bar-text" id="dialog-title">Message</div>
<div class="title-bar-controls">
        <button aria-label="Close" onclick="closeMessageDialog()"></button>
</div>
</div>
<div class="window-body">
<p id="dialog-message"></p>
<div style="text-align: right; margin-top: 15px;">
        <button onclick="closeMessageDialog()">OK</button>
</div>
</div>
</div>
</div>

<!-- Poster Selection Modal -->
<div id="poster-selection-modal" class="modal" style="display: none; z-index: 1100;">
<div class="modal-content window" style="width: 80%; max-width: 800px; max-height: 90vh; display: flex; flex-direction: column;">
<div class="title-bar">
<div class="title-bar-text">Select Poster</div>
<div class="title-bar-controls">
        <button aria-label="Close" onclick="closePosterSelectionModal()"></button>
</div>
</div>
<div class="window-body" style="overflow-y: auto; flex: 1;">
<div id="poster-loading" style="text-align: center; padding: 20px;">
        <p>Loading posters...</p>
</div>
<div id="poster-grid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 10px; margin-top: 10px;">
        <!-- Posters will be loaded here -->
</div>
</div>
</div>
</div>

<!-- Backdrop Selection Modal -->
<div id="backdrop-selection-modal" class="modal" style="display: none; z-index: 1100;">
<div class="modal-content window" style="width: 80%; max-width: 800px; max-height: 90vh; display: flex; flex-direction: column;">
<div class="title-bar">
<div class="title-bar-text">Select Backdrop</div>
<div class="title-bar-controls">
        <button aria-label="Close" onclick="closeBackdropSelectionModal()"></button>
</div>
</div>
<div class="window-body" style="overflow-y: auto; flex: 1;">
<div id="backdrop-loading" style="text-align: center; padding: 20px;">
        <p>Loading backdrops...</p>
</div>
<div id="backdrop-grid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 10px; margin-top: 10px;">
        <!-- Backdrops will be loaded here -->
</div>
</div>
</div>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
let allResults = [];
let currentPage = 1;
let totalPages = 0;
let selectedMovie = null;
let taskCheckInterval = null;
let currentTaskId = null;
let isLoadingMore = false;
let currentQuery = '';
let hasMoreResults = false;

// Modal Control Functions
function openModal(searchQuery = '') {
        $("#movie-search-modal").show();
        if (searchQuery) {
                $("#query").val(searchQuery);
                // Auto-trigger search if query provided
                if (searchQuery.length > 2) {
                        currentQuery = searchQuery;
                        currentPage = 1;
                        allResults = [];
                        $('#results-list').empty(); // Clear any existing results
                        fetchResults(searchQuery, currentPage, false);
                }
        }
        $("#query").focus();
}

function closeModal() {
        $("#movie-search-modal").hide();
        resetModal();
}

// Message Dialog Functions
function showMessage(title, message, isError = false) {
        $("#dialog-title").text(title);
        $("#dialog-message").text(message);
        $("#dialog-message").css("color", isError ? "red" : "black");
        $("#message-dialog").show();
}

function closeMessageDialog() {
        $("#message-dialog").hide();
}

function resetModal() {
        // Reset stage
        $("#modal-stage-1").show();
        $("#modal-stage-2").hide();
        
        // Reset search
        $("#query").val("");
        $("#results-list").empty();
        $("#total-results").text("0");
        
        // Reset form
        $("#add-movie-form")[0].reset();
        selectedMovie = null;
        $("#to-stage-2-btn").prop("disabled", true);
        
        // Reset tabs
        $("#tab-general").attr("aria-selected", "true");
        $("#tab-images").attr("aria-selected", "false");
        $("#tab-content-general").show();
        $("#tab-content-images").hide();
        
        // Reset infinite scroll variables
        allResults = [];
        currentPage = 1;
        currentQuery = '';
        hasMoreResults = false;
        isLoadingMore = false;
        
        // Hide selection hint
        $('#movie-selection-hint').hide();
}

function goToStage2() {
        if (!selectedMovie) return;
        
        // Fill form with selected movie data
        $("#tmdb_id").val(selectedMovie.id);
        
        // Populate display fields and hidden inputs
        $("#title-display").val(selectedMovie.title);
        $("#title-hidden").val(selectedMovie.title);
        
        $("#release_date-display").val(selectedMovie.release_date || 'N/A');
        $("#release_date-hidden").val(selectedMovie.release_date || '');
        
        const description = selectedMovie.overview || 'No description available';
        $("#description-display").val(description);
        $("#description-hidden").val(selectedMovie.overview || '');
        
        // Set preview images
        if (selectedMovie.poster_path) {
            $("#movie-poster-preview").attr("src", `https://image.tmdb.org/t/p/w500${selectedMovie.poster_path}`);
            $("#default-poster-path").val(selectedMovie.poster_path);
        } else {
            $("#movie-poster-preview").attr("src", ""); // Clear if no poster
        }
        
        if (selectedMovie.backdrop_path) {
            $("#movie-backdrop-preview").attr("src", `https://image.tmdb.org/t/p/w500${selectedMovie.backdrop_path}`);
            $("#default-backdrop-path").val(selectedMovie.backdrop_path);
        } else {
            $("#movie-backdrop-preview").attr("src", ""); // Clear if no backdrop
        }
        
        // Switch stages
        $("#modal-stage-1").hide();
        $("#modal-stage-2").css("display", "flex"); // Use flex for the new layout
        $("#modal-title").text("Edit Movie Details");
}

function goToStage1() {
        $("#modal-stage-2").hide();
        $("#modal-stage-1").show();
        $("#modal-title").text("Add Movie");
}

// Poster Selection Modal Functions
function openPosterSelectionModal() {
        if (!selectedMovie) return;
        $("#poster-grid").empty();
        $("#poster-loading").show();
        $("#poster-selection-modal").show();
        fetchMovieImages(selectedMovie.id);
}

function closePosterSelectionModal() {
        $("#poster-selection-modal").hide();
}

// Backdrop Selection Modal Functions
function openBackdropSelectionModal() {
        if (!selectedMovie) return;
        $("#backdrop-grid").empty();
        $("#backdrop-loading").show();
        $("#backdrop-selection-modal").show();
        fetchMovieImages(selectedMovie.id);
}

function closeBackdropSelectionModal() {
        $("#backdrop-selection-modal").hide();
}

// Fetch movie images from TMDB
function fetchMovieImages(movieId) {
        $.ajax({
                        url: "{% url 'movie_images' %}",
                        method: "GET",
                        data: { movie_id: movieId },
                        success: function(response) {
                                        const data = JSON.parse(response);
                                        // Load posters
                                        $("#poster-loading").hide();                                        if (data.posters && data.posters.length > 0) {
                                                        data.posters.forEach(poster => {
                                                                        const resolution = `${poster.width}×${poster.height}`;
                                                                        const containerElement = $('<div>', {
                                                                                        class: 'image-container',
                                                                                        style: 'position: relative; cursor: pointer; border: 2px solid transparent;'
                                                                        });
                                                                        
                                                                        const imgElement = $('<img>', {
                                                                                        src: `https://image.tmdb.org/t/p/w200${poster.file_path}`,
                                                                                        alt: 'Movie poster',
                                                                                        style: 'width: 100%; display: block;',
                                                                                        'data-path': poster.file_path
                                                                        });
                                                                        
                                                                        const resolutionOverlay = $('<div>', {
                                                                                        class: 'resolution-overlay',
                                                                                        text: resolution,
                                                                                        style: 'position: absolute; bottom: 4px; right: 4px; background: rgba(0,0,0,0.8); color: white; padding: 2px 6px; font-size: 10px; border-radius: 0px; font-family: monospace;'
                                                                        });
                                                                        
                                                                        containerElement.append(imgElement, resolutionOverlay);
                                                                        containerElement.click(function() {
                                                                                        // Select this poster
                                                                                        $("#poster-grid .image-container").css('border', '2px solid transparent');
                                                                                        $(this).css('border', '2px solid #000080');
                                                                                        $("#movie-poster-preview").attr("src", `https://image.tmdb.org/t/p/w500${poster.file_path}`);
                                                                                        $("#default-poster-path").val(poster.file_path);
                                                                                        closePosterSelectionModal();
                                                                        });
                                                                        $("#poster-grid").append(containerElement);
                                                        });
                                        } else {
                                                        $("#poster-grid").html("<p>No posters available.</p>");
                                        }
                                        
                                        // Load backdrops
                                        $("#backdrop-loading").hide();                                        if (data.backdrops && data.backdrops.length > 0) {
                                                        data.backdrops.forEach(backdrop => {
                                                                        const resolution = `${backdrop.width}×${backdrop.height}`;
                                                                        const containerElement = $('<div>', {
                                                                                        class: 'image-container',
                                                                                        style: 'position: relative; cursor: pointer; border: 2px solid transparent;'
                                                                        });
                                                                        
                                                                        const imgElement = $('<img>', {
                                                                                        src: `https://image.tmdb.org/t/p/w300${backdrop.file_path}`,
                                                                                        alt: 'Movie backdrop',
                                                                                        style: 'width: 100%; display: block;',
                                                                                        'data-path': backdrop.file_path
                                                                        });
                                                                        
                                                                        const resolutionOverlay = $('<div>', {
                                                                                        class: 'resolution-overlay',
                                                                                        text: resolution,
                                                                                        style: 'position: absolute; bottom: 4px; right: 4px; background: rgba(0,0,0,0.8); color: white; padding: 2px 6px; font-size: 10px; border-radius: 0px; font-family: monospace;'
                                                                        });
                                                                        
                                                                        containerElement.append(imgElement, resolutionOverlay);
                                                                        containerElement.click(function() {
                                                                                        // Select this backdrop
                                                                                        $("#backdrop-grid .image-container").css('border', '2px solid transparent');
                                                                                        $(this).css('border', '2px solid #000080');
                                                                                        $("#movie-backdrop-preview").attr("src", `https://image.tmdb.org/t/p/w500${backdrop.file_path}`);
                                                                                        $("#default-backdrop-path").val(backdrop.file_path);
                                                                                        closeBackdropSelectionModal();
                                                                        });
                                                                        $("#backdrop-grid").append(containerElement);
                                                        });
                                        } else {
                                                        $("#backdrop-grid").html("<p>No backdrops available.</p>");
                                        }
                        },
                        error: function() {
                                        $("#poster-loading").hide();
                                        $("#backdrop-loading").hide();
                                        $("#poster-grid").html("<p>Failed to load images. Please try again.</p>");
                                        $("#backdrop-grid").html("<p>Failed to load images. Please try again.</p>");
                        }
        });
}

function renderResults(newResults = null) {
    const resultsToRender = newResults || allResults;
    
    if (!newResults) {
        // Clear list for new search
        $('#results-list').empty();
    }
    
    resultsToRender.forEach(function(movie) {
        const listItem = $('<li></li>');
        const poster = movie.poster_path
        ? `<img src="https://image.tmdb.org/t/p/w200${movie.poster_path}" 
        alt="${movie.title} poster" style="width: 50px; height: auto; vertical-align: middle; margin-right: 10px;">`
        : '';

        // Create database status indicators
        let statusIndicators = '';
        if (movie.in_database) {
        statusIndicators += `<span class="status-pill in-database">
        <a href="/movies/${movie.id}/" class="status-link">View Movie</a>
        </span>`;
        }
        if (movie.in_watchlist) {
        statusIndicators += `<span class="status-pill in-watchlist">
        <a href="/watchlist/movies/" class="status-link">In Watchlist</a>
        </span>`;
        }

        listItem.html(`
        <div class="movie-result">
        ${poster}
        <span class="movie-title">${movie.title} (${movie.release_date || 'N/A'})</span>
        <div class="movie-status">${statusIndicators}</div>
        </div>
        `);

        listItem.on('click', function() {
        selectedMovie = movie;
        $("#to-stage-2-btn").prop("disabled", false);

        // Highlight selected item
        $('#results-list li').removeClass('selected');
        $(this).addClass('selected');
        
        // Hide the selection hint once a movie is selected
        $('#movie-selection-hint').hide();
        });

        $('#results-list').append(listItem);
    });
    
    // Show selection hint when results are displayed (but only if no movie is selected)
    if (resultsToRender.length > 0 && !selectedMovie && !newResults) {
        $('#movie-selection-hint').show();
    }
}

function updatePagination(response) {
    $('#total-results').text(response.total_results);
    totalPages = response.total_pages;
    hasMoreResults = currentPage < totalPages;
}

function fetchResults(query, page, append = false) {
    if (isLoadingMore) return; // Prevent multiple simultaneous requests
    
    isLoadingMore = true;
    if (!append) {
        $("#loading-more").hide();
    } else {
        $("#loading-more").show();
    }
    
    $.ajax({
        url: "{% url 'tmdb_search' %}",
        method: "GET",
        data: { query: query, page: page },
        success: function(response) {
            if (append) {
                // Append new results to existing ones
                allResults = allResults.concat(response.results);
                // Only render the new results
                renderResults(response.results);
            } else {
                // Replace results for new search
                allResults = response.results;
                // Render all results (will clear list first)
                renderResults();
            }
            
            updatePagination(response);
            isLoadingMore = false;
            $("#loading-more").hide();
        },
        error: function() {
            alert('An error occurred while searching for movies.');
            isLoadingMore = false;
            $("#loading-more").hide();
        }
    });
}

// Function to check task status
function checkMovieTaskStatus(taskId) {
    $.ajax({
        url: "{% url 'movie-task-status' %}",
        method: "GET",
        data: { task_id: taskId },
        success: function(response) {
            if (response.complete) {
                // Task is complete
                clearInterval(taskCheckInterval);
                
                if (response.success) {
                    // Task was successful
                    $("#loading-screen-modal").hide();
                    showMessage("Success", "Movie added successfully!");
                    // Try to refresh the main search if the function exists
                    if (typeof performSearch === 'function' && typeof window.getCurrentEndpoint === 'function') {
                        performSearch(window.getCurrentQuery(), window.getCurrentEndpoint());
                    }
                    closeModal();
                } else {
                    // Task failed
                    $("#loading-screen-modal").hide();
                    let errorMsg = "Failed to add movie.";
                    if (response.error) {
                        errorMsg = response.error;
                    }
                    showMessage("Error", errorMsg, true);
                }
            } else {
                // Task is still running
                $("#movie-loading-message").text("Adding movie to your list... (Processing in background)");
                $("#movie-task-info").show();
            }
        },
        error: function() {
            // Handle error checking task status
            console.log("Error checking task status");
        }
    });
}

// Submit movie to API
function submitMovie() {
        const movieId = $("#tmdb_id").val();
        const posterPath = $("#default-poster-path").val();
        const backdropPath = $("#default-backdrop-path").val();
        const isAnime = $("#is_anime").is(':checked');
        const addToWatchlist = $("#add_to_watchlist").is(':checked');
        
        if (!movieId) {
                        showMessage("Error", "Movie ID is missing", true);
                        return;
        }
        
        // Create data object
        const movieData = {
                        id: movieId,
                        poster: posterPath,
                        backdrop: backdropPath,
                        is_anime: isAnime,
                        add_to_watchlist: addToWatchlist
        };
        
        // Get CSRF token from the form
        const csrfToken = $("input[name=csrfmiddlewaretoken]").val();
        
        // Show loading screen
        $("#loading-screen-modal").show();
        
        // Submit to API
        $.ajax({
                        url: "{% url 'movies-list' %}",
                        method: "POST",
                        data: JSON.stringify(movieData),
                        contentType: "application/json",
                        headers: {
                                        "X-CSRFToken": csrfToken
                        },
                        success: function(response) {
                            // Handle background task response
                            if (response.task_id) {
                                currentTaskId = response.task_id;
                                
                                // Show message that task is running in background after 3 seconds
                                setTimeout(function() {
                                    $("#movie-task-info").show();
                                }, 3000);
                                
                                // Start checking task status
                                taskCheckInterval = setInterval(function() {
                                    checkMovieTaskStatus(currentTaskId);
                                }, 5000); // Check every 5 seconds
                                
                                // Do initial check after 2 seconds
                                setTimeout(function() {
                                    checkMovieTaskStatus(currentTaskId);
                                }, 2000);
                            } else {
                                // If no task_id, assume it's a direct response
                                $("#loading-screen-modal").hide();
                                showMessage("Success", "Movie added successfully!");
                                // Try to refresh the main search if the function exists
                                if (typeof performSearch === 'function' && typeof window.getCurrentEndpoint === 'function') {
                                    performSearch(window.getCurrentQuery(), window.getCurrentEndpoint());
                                }
                                closeModal();
                            }
                        },
                        error: function(xhr) {
                                        // Hide loading screen
                                        $("#loading-screen-modal").hide();
                                        let errorMsg = "Failed to add movie.";
                                        if (xhr.responseJSON && xhr.responseJSON.error) {
                                                        errorMsg = xhr.responseJSON.error;
                                        }
                                        showMessage("Error", errorMsg, true);
                        }
        });
}

$(document).ready(function() {
        // Modal control
        $("#close-modal-btn").on("click", closeModal);
        
        // Stage navigation
        $("#to-stage-2-btn").on("click", goToStage2);
        $("#back-to-stage-1-btn").on("click", goToStage1);
        
        // Tab navigation
        $("#tab-general a").on("click", function(e) {
            e.preventDefault();
            $("#tab-general").attr("aria-selected", "true");
            $("#tab-images").attr("aria-selected", "false");
            $("#tab-content-general").show();
            $("#tab-content-images").hide();
        });
        
        $("#tab-images a").on("click", function(e) {
            e.preventDefault();
            $("#tab-general").attr("aria-selected", "false");
            $("#tab-images").attr("aria-selected", "true");
            $("#tab-content-general").hide();
            $("#tab-content-images").show();
        });
        
        // Form submission
        $("#submit-movie-btn").on("click", submitMovie);
        
        // Prevent default form submission
        $("#add-movie-form").on("submit", function(e) {
                        e.preventDefault();
                        submitMovie();
        });
        
        // Search functionality
        $('#query').on('input', function() {
            const query = $('#query').val();
            if (query.length > 2) {
                if (query !== currentQuery) {
                    // New search - reset everything
                    currentQuery = query;
                    currentPage = 1;
                    allResults = [];
                    $('#results-list').empty(); // Clear previous results immediately
                    fetchResults(query, currentPage, false);
                }
            } else {
                // Clear results if query is too short
                $('#results-list').empty();
                $('#total-results').text('0');
                allResults = [];
                currentQuery = '';
                hasMoreResults = false;
            }
        });

        $('#search-button').on('click', function() {
            const query = $('#query').val();
            if (query.length > 2) {
                currentQuery = query;
                currentPage = 1;
                allResults = [];
                $('#results-list').empty(); // Clear previous results immediately
                fetchResults(query, currentPage, false);
            }
        });

        // Infinite scroll functionality
        $('#results-list').parent().on('scroll', function() {
            const scrollContainer = $(this);
            const scrollTop = scrollContainer.scrollTop();
            const scrollHeight = scrollContainer[0].scrollHeight;
            const containerHeight = scrollContainer.height();
            
            // Check if user has scrolled to near the bottom (within 50px)
            // Also check if there's actually content to scroll (scrollHeight > containerHeight)
            if (scrollHeight > containerHeight && scrollTop + containerHeight >= scrollHeight - 50) {
                if (hasMoreResults && !isLoadingMore && currentQuery.length > 2) {
                    currentPage++;
                    fetchResults(currentQuery, currentPage, true);
                }
            }
        });
        
        // Also add a fallback check with mousewheel/touch events for better detection
        $('#results-list').parent().on('mousewheel DOMMouseScroll touchmove', function() {
            // Trigger the scroll event handler after a short delay
            setTimeout(() => {
                $(this).trigger('scroll');
            }, 100);
        });

        // Add this to your existing document ready function
        $("#movie-close-loading-btn").on("click", function() {
            $("#loading-screen-modal").hide();
            // Note: We keep the interval running to check status in the background
            showMessage("Background Processing", 
                "The movie addition process will continue in the background. " +
                "You can check your library later to see when it's complete.");
            closeModal();
        });
});
</script>

<style>
/* Theme-adaptive CSS variables for modal components */
:root {
    --bg-color: #c0c0c0;
    --text-color: #000;
    --text-muted: #666;
    --border-dark: #808080;
    --border-light: #dfdfdf;
    --window-bg: #c0c0c0;
    --button-bg: #c0c0c0;
    --button-text: #000;
    --button-hover: #e0e0e0;
    --progress-bg: #fff;
    --progress-bar: #008080;
    --shadow-color: rgba(0,0,0,0.25);
    --poster-border: #a0a0a0;
    --input-bg: white;
    --hover-bg: #d4d0c8;
    --secondary-text: #666;
    --poster-bg: #808080;
}

@media (prefers-color-scheme: dark) {
    :root {
        --bg-color: #383838;
        --text-color: #ffffff;
        --text-muted: #b0b0b0;
        --border-dark: #2a2a2a;
        --border-light: #505050;
        --window-bg: #404040;
        --button-bg: #505050;
        --button-text: #ffffff;
        --button-hover: #606060;
        --progress-bg: #2a2a2a;
        --progress-bar: #00a0a0;
        --shadow-color: rgba(0,0,0,0.5);
        --poster-border: #606060;
        --input-bg: #383838;
        --hover-bg: #404040;
        --secondary-text: #cccccc;
        --poster-bg: #555555;
    }
}

.modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.7);
    z-index: 1000;
    display: flex;
    justify-content: center;
    align-items: center;
}

.modal-content {
    position: relative;
    margin: auto;
}

/* Theme-adaptive modal content */
.modal .window {
    background-color: var(--window-bg);
    box-shadow: 2px 2px 10px rgba(0,0,0,0.5);
}

.modal .window-body {
    background-color: var(--window-bg);
    color: var(--text-color);
}

@media (prefers-color-scheme: dark) {
    .modal .title-bar {
        background: linear-gradient(90deg, var(--win98-dark), var(--win98-light));
    }
}

/* Form elements theme adaptation */
.modal input[type="text"] {
    background: var(--input-bg);
    color: var(--text-color);
    border: 1px inset var(--bg-color);
}

.modal fieldset {
    border: 2px inset var(--bg-color);
    background-color: var(--window-bg);
    color: var(--text-color);
}

.modal legend {
    color: var(--text-color);
}

.modal button {
    background: var(--button-bg);
    color: var(--button-text);
    border-top: 1px solid var(--border-light);
    border-left: 1px solid var(--border-light);
    border-right: 1px solid var(--border-dark);
    border-bottom: 1px solid var(--border-dark);
}

.modal button:hover {
    background: var(--button-hover);
}

.modal button:active {
    border-top: 1px solid var(--border-dark);
    border-left: 1px solid var(--border-dark);
    border-right: 1px solid var(--border-light);
    border-bottom: 1px solid var(--border-light);
}

.modal label {
    color: var(--text-color);
}

/* Results list styling */
.modal .tree-view {
    background-color: var(--input-bg);
    color: var(--text-color);
    border: 2px inset var(--bg-color);
}

.modal .tree-view li {
    color: var(--text-color);
}

.modal .tree-view li:hover {
    background-color: var(--hover-bg);
}

.selected {
    background-color: #000080 !important;
    color: white !important;
}

#poster-grid img:hover, #backdrop-grid img:hover {
    border: 2px solid #000080 !important;
}

.progress-indicator {
    width: 100%;
    height: 20px;
    background-color: var(--progress-bg);
    border: 2px inset var(--bg-color);
    margin-top: 15px;
    overflow: hidden;
    position: relative;
}

.progress-indicator-bar {
    display: block;    height: 100%;
    background-color: var(--progress-bar);
    position: absolute;
    top: 0;
    left: 0;
    width: 40%;
    animation: progress-animation 1.5s infinite linear;
}

@keyframes progress-animation {
    0% {
        width: 0%;
    }
    100% {
        width: 100%;
    }
}

.movie-result {
    display: flex;
    align-items: center;
    position: relative;
    padding: 5px 0;
}

.movie-title {
    flex-grow: 1;
    color: var(--text-color);
}

.movie-status {
    display: flex;
    gap: 5px;
    margin-left: 10px;
}

.status-pill {
    font-size: 12px;
    padding: 2px 8px;
    border: 1px solid var(--border-dark);
    background: var(--button-bg);
    color: var(--text-color);
    white-space: nowrap;
    border-radius: 0px;
}

.in-database {
    border-color: #008000;
}

.in-watchlist {
    border-color: #FFA500;
}

.status-link {
    text-decoration: none;
    color: var(--text-color);
}

.status-link:hover {
    text-decoration: underline;
}

/* Override base template's mobile field-row behavior for inline title/date fields */
@media (max-width: 768px) {
    /* Keep title and release date inline on mobile */
    .modal .field-row {
        display: flex !important;
        flex-direction: row !important;
        align-items: center !important;
        flex-wrap: wrap !important;
    }
    
    .modal .field-row label {
        min-width: 70px !important;
        margin-right: 8px !important;
        margin-bottom: 0 !important;
        flex-shrink: 0 !important;
    }
    
    .modal .field-row span,
    .modal .field-row input:not([type="checkbox"]) {
        flex: 1 !important;
        min-width: 120px !important;
        margin-left: 0 !important;
    }
    
    /* Ensure description remains stacked */
    .modal .field-row-stacked {
        display: flex !important;
        flex-direction: column !important;
    }
    
    .modal .field-row-stacked label {
        min-width: unset !important;
        margin-right: 0 !important;
        margin-bottom: 5px !important;
    }
}

/* Override base template's width: 100% rule for search component elements */
.modal .field-row > *,
.modal .field-row-stacked > * {
    width: auto !important;
}

/* Specific overrides for elements that should maintain their original styling */
.modal .field-row span,
.modal .field-row input:not([type="checkbox"]) {
    width: auto !important;
    flex: 1;
}

.modal .field-row-stacked > div {
    width: 100% !important; /* Description div should still be full width */
}

/* Tab styling overrides */
menu[role="tablist"] {
    margin-bottom: -2px !important; /* Connect tabs to the window below */
    position: relative;
    z-index: 10;
}

div[role="tabpanel"] {
    background: var(--window-bg);
    position: relative;
    z-index: 1;
}

/* Force sharp corners for Windows 98 aesthetic */
.modal .window,
.modal .window-body,
.modal button,
.modal input,
.modal textarea,
.modal select,
.modal .status-pill,
.modal .sunken-panel,
.modal .title-bar,
.modal .title-bar-controls button {
    border-radius: 0 !important;
}

/* Ensure title bar gradient works in dark mode */
@media (prefers-color-scheme: dark) {
    .modal .title-bar {
        background: linear-gradient(90deg, var(--win98-dark, #000080), var(--win98-light, #1084d0)) !important;
    }
}
</style>
