{% load static %}

<div class="search-wrapper">
    <!-- Compact Search Bar -->
    <div class="win98-search-bar">
        <div class="search-input-row">
            <img src="{% static 'images/win98/search_globe_transparent.gif' %}" alt="" class="search-icon">
            <input type="text" 
                   id="searchInput" 
                   name="search" 
                   placeholder="Search..."
                   value="{{ request.GET.search }}"
                   autocomplete="off"
                   autocorrect="off"
                   autocapitalize="off"
                   spellcheck="false">
            <button id="cancelButton" class="win98-btn-small" onclick="clearSearch()" style="display: none;" aria-label="Close">
                <img src="{% static 'images/win98/close_icon.png' %}" alt="X" style="width: 12px; height: 12px; image-rendering: pixelated;">
            </button>
        </div>

        <!-- Tabs (Hidden by default) -->
        <div id="searchTabs" class="win98-tabs" style="display: none;">
            <button class="search-tab active" data-endpoint="movies">Movies</button>
            <button class="search-tab" data-endpoint="tvshows">TV Shows</button>
            <button class="search-tab" data-endpoint="people">People</button>
            <button class="search-tab" data-endpoint="users">Users</button>
        </div>
    </div>

    <!-- Results Dropdown (Floating) -->
    <div id="searchResults" class="win98-results-dropdown" style="display: none;">
        <div class="results-status-bar" id="resultsCount">Ready</div>
        <div class="sunken-panel">
            <div id="resultsGrid" class="results-list">
                <!-- Results populated by JS -->
            </div>
        </div>
        
        <!-- Add Content Container -->
        <div id="addContentContainer" style="display: none; padding: 4px; text-align: center; border-top: 1px solid var(--win98-dark);">
            <button type="button" id="addMovieButton" class="win98-btn-small" style="display: none; width: 100%;">Add Movie</button>
            <button type="button" id="addTvShowButton" class="win98-btn-small" style="display: none; width: 100%;">Add TV Show</button>
        </div>
    </div>
</div>

<style>
    .search-wrapper {
        position: relative;
        max-width: 800px;
        margin: 0 auto 10px auto;
        z-index: 1000;
    }

    .win98-search-bar {
        background: var(--win98-gray);
        border: 2px solid var(--win98-light);
        border-right-color: var(--win98-dark);
        border-bottom-color: var(--win98-dark);
        padding: 4px;
        box-shadow: 1px 1px 0 var(--win98-black);
    }

    .search-input-row {
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .search-icon {
        width: 16px;
        height: 16px;
        image-rendering: pixelated;
    }

    #searchInput {
        flex: 1;
        height: 30px;
        border: 2px solid;
        border-color: var(--win98-dark) var(--win98-light) var(--win98-light) var(--win98-dark);
        padding: 0 6px;
        font-family: 'MS Sans Serif', 'Segoe UI', sans-serif;
        font-size: 14px;
        background: var(--win98-input-bg);
        color: var(--win98-input-text);
        outline: none;
    }

    .win98-btn-small {
        min-width: 30px;
        height: 30px;
        padding: 0 8px;
        background: var(--win98-gray);
        color: var(--win98-text);
        font-family: 'MS Sans Serif', sans-serif;
        font-size: 12px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        
        /* Win98 Button Style (Outset) - Matching Navbar */
        border-top: 1px solid var(--win98-light);
        border-left: 1px solid var(--win98-light);
        border-right: 1px solid var(--win98-black);
        border-bottom: 1px solid var(--win98-black);
        box-shadow: 1px 1px 0 var(--win98-black), inset 1px 1px 0 var(--win98-light), inset -1px -1px 0 var(--win98-dark);
        transition: none;
    }

    .win98-btn-small:active {
        /* Win98 Pressed Style (Inset) - Matching Navbar */
        border-top: 1px solid var(--win98-black);
        border-left: 1px solid var(--win98-black);
        border-right: 1px solid var(--win98-light);
        border-bottom: 1px solid var(--win98-light);
        box-shadow: inset 1px 1px 0 var(--win98-dark);
        
        /* Dithered pattern for active state */
        background-image: linear-gradient(45deg, var(--win98-active-pattern) 25%, transparent 25%, transparent 75%, var(--win98-active-pattern) 75%, var(--win98-active-pattern)), 
                          linear-gradient(45deg, var(--win98-active-pattern) 25%, transparent 25%, transparent 75%, var(--win98-active-pattern) 75%, var(--win98-active-pattern));
        background-position: 0 0, 1px 1px;
        background-size: 4px 4px;
        
        padding-top: 0;
        padding-left: 0;
    }

    .win98-tabs {
        display: flex;
        gap: 2px;
        margin-top: 6px;
        padding-left: 24px;
    }

    .search-tab {
        background: var(--win98-gray);
        border: none;
        box-shadow: inset 1px 1px var(--win98-light), 
                    inset -1px 0 var(--win98-dark), 
                    inset -2px 0 var(--win98-black);
        padding: 4px 8px;
        font-family: 'MS Sans Serif', sans-serif;
        font-size: 12px;
        color: var(--win98-text);
        cursor: pointer;
        border-radius: 3px 3px 0 0;
        margin-right: 2px;
    }

    .search-tab.active {
        font-weight: bold;
        padding-bottom: 5px;
        position: relative;
        top: 2px;
        z-index: 2;
        box-shadow: inset 1px 1px var(--win98-light), 
                    inset -1px 0 var(--win98-dark), 
                    inset -2px 0 var(--win98-black);
    }

    .win98-results-dropdown {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        background: var(--win98-gray);
        border: 2px outset var(--win98-light);
        box-shadow: 2px 2px 10px rgba(0,0,0,0.5);
        margin-top: 2px;
        padding: 2px;
        display: flex;
        flex-direction: column;
    }

    .results-status-bar {
        font-family: 'MS Sans Serif', sans-serif;
        font-size: 11px;
        color: var(--win98-text);
        padding: 2px 4px;
        margin-bottom: 2px;
    }

    .sunken-panel {
        border: 2px solid;
        border-color: var(--win98-dark) var(--win98-light) var(--win98-light) var(--win98-dark);
        background: var(--win98-input-bg);
        max-height: 60vh;
        overflow-y: auto;
    }

    .result-item {
        display: flex;
        align-items: center;
        padding: 4px;
        cursor: pointer;
        color: var(--win98-input-text);
        border: 1px dotted transparent;
    }

    .result-item:hover {
        background-color: #000080;
        color: white;
        border: 1px dotted #ffffff;
    }

    @media (prefers-color-scheme: dark) {
        .result-item:hover {
            background-color: #004e98;
        }
    }

    .result-poster {
        width: 32px;
        height: 48px;
        object-fit: cover;
        margin-right: 8px;
        border: 1px solid var(--win98-dark);
    }

    .result-poster-placeholder {
        width: 32px;
        height: 48px;
        background: var(--win98-dark);
        margin-right: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 8px;
    }

    .result-content {
        flex: 1;
        min-width: 0;
    }

    .result-title {
        font-family: 'MS Sans Serif', sans-serif;
        font-size: 12px;
        font-weight: bold;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .result-meta {
        font-size: 10px;
        opacity: 0.8;
    }

    .user-avatar {
        width: 32px;
        height: 32px;
        background: var(--win98-dark);
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-right: 8px;
        font-weight: bold;
        border: 1px solid var(--win98-light);
    }
</style>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const searchInput = document.getElementById('searchInput');
        const searchTabs = document.getElementById('searchTabs');
        const cancelButton = document.getElementById('cancelButton');
        const searchResults = document.getElementById('searchResults');
        const defaultContent = document.getElementById('defaultContent');
        const resultsGrid = document.getElementById('resultsGrid');
        const resultsCount = document.getElementById('resultsCount');
        const addContentContainer = document.getElementById('addContentContainer');
        const addMovieButton = document.getElementById('addMovieButton');
        const addTvShowButton = document.getElementById('addTvShowButton');
        
        let currentEndpoint = 'movies';
        let searchTimeout = null;

        const placeholders = {
            'movies': 'Search for movies...',
            'tvshows': 'Search for TV shows...',
            'people': 'Search for people...',
            'users': 'Search for users...'
        };

        function clearSearch() {
            searchInput.value = '';
            searchTabs.style.display = 'none';
            cancelButton.style.display = 'none';
            searchResults.style.display = 'none';
            if (defaultContent) defaultContent.style.display = 'block';
            addContentContainer.style.display = 'none';
            searchInput.blur();
        }

        function performSearch(query, type) {
            if (!query.trim()) {
                clearSearch();
                return;
            }

            searchResults.style.display = 'flex';
            if (defaultContent) defaultContent.style.display = 'none';
            
            resultsGrid.innerHTML = '<div style="padding: 10px; text-align: center;">Searching...</div>';
            resultsCount.textContent = 'Searching...';

            fetch(`{% url 'discover_search' %}?search=${encodeURIComponent(query)}&type=${type}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        displayResults(data);
                    } else {
                        resultsGrid.innerHTML = `<div style="padding: 10px; text-align: center;">Error: ${data.error}</div>`;
                        resultsCount.textContent = 'Error';
                    }
                })
                .catch(error => {
                    console.error('Search error:', error);
                    resultsGrid.innerHTML = '<div style="padding: 10px; text-align: center;">Search failed.</div>';
                    resultsCount.textContent = 'Failed';
                });
        }

        function displayResults(data) {
            resultsCount.textContent = `${data.count} object(s) found`;

            if (data.results.length === 0) {
                resultsGrid.innerHTML = '<div style="padding: 10px; text-align: center;">No results found</div>';
                addAddContentResults();
                return;
            }

            resultsGrid.innerHTML = '';

            data.results.forEach(item => {
                const resultItem = document.createElement('div');
                resultItem.className = 'result-item';
                resultItem.onclick = () => window.location.href = item.url;

                if (data.search_type === 'users') {
                    resultItem.innerHTML = `
                        <div class="user-avatar">${item.username.charAt(0).toUpperCase()}</div>
                        <div class="result-content">
                            <div class="result-title">${item.username}</div>
                        </div>
                    `;
                } else if (data.search_type === 'people') {
                    resultItem.innerHTML = `
                        ${item.profile_picture ? 
                            `<img src="${item.profile_picture}" alt="${item.name}" class="result-poster">` : 
                            '<div class="result-poster-placeholder">No Image</div>'
                        }
                        <div class="result-content">
                            <div class="result-title">${item.name}</div>
                            <div class="result-meta">
                                ${item.avg_rating ? `<span>Rating: ${item.avg_rating}/10</span>` : ''}
                            </div>
                        </div>
                    `;
                } else {
                    let yearText = '';
                    if (item.year) {
                        yearText = (item.end_year && item.end_year !== item.year) ? 
                            `${item.year}-${item.end_year}` : item.year.toString();
                    }

                    resultItem.innerHTML = `
                        ${item.poster ? 
                            `<img src="${item.poster}" alt="${item.title}" class="result-poster">` : 
                            '<div class="result-poster-placeholder">No Poster</div>'
                        }
                        <div class="result-content">
                            <div class="result-title">${item.title}</div>
                            <div class="result-meta">
                                <span>${yearText}</span>
                                ${item.avg_rating ? `<span>â˜… ${item.avg_rating}</span>` : ''}
                                ${item.in_watchlist ? '<span style="color: #008000; font-weight: bold;">(In Watchlist)</span>' : ''}
                            </div>
                        </div>
                    `;
                }

                resultsGrid.appendChild(resultItem);
            });
            
            addAddContentResults();
        }

        function addAddContentResults() {
            if (currentEndpoint === 'movies' || currentEndpoint === 'tvshows') {
                const addResultItem = document.createElement('div');
                addResultItem.className = 'result-item';
                addResultItem.style.borderTop = '1px dotted var(--win98-dark)';
                addResultItem.style.marginTop = '4px';
                
                const buttonText = currentEndpoint === 'movies' ? 'Add Movie' : 'Add TV Show';
                const currentQuery = searchInput.value.trim();
                
                addResultItem.innerHTML = `
                    <div class="result-poster-placeholder" style="background: var(--win98-gray); color: var(--win98-text); border: 1px solid var(--win98-text);">
                        <span style="font-size: 16px; font-weight: bold;">+</span>
                    </div>
                    <div class="result-content">
                        <div class="result-title">${buttonText}</div>
                        <div class="result-meta">
                            <span>Not found? Add it to the database!</span>
                        </div>
                    </div>
                `;
                
                addResultItem.onclick = () => {
                    if (currentEndpoint === 'movies') {
                        if (typeof openModal === 'function') openModal(currentQuery);
                        else window.location.href = "{% url 'home_page' %}";
                    } else if (currentEndpoint === 'tvshows') {
                        if (typeof openTVShowModal === 'function') openTVShowModal(currentQuery);
                        else window.location.href = "{% url 'home_page' %}";
                    }
                };
                
                resultsGrid.appendChild(addResultItem);
            }
        }

        searchInput.addEventListener('focus', function() {
            searchTabs.style.display = 'flex';
            cancelButton.style.display = 'flex';
            if (searchInput.value.trim()) performSearch(searchInput.value, currentEndpoint);
        });

        document.querySelectorAll('.search-tab').forEach(tab => {
            tab.addEventListener('click', function() {
                document.querySelectorAll('.search-tab').forEach(t => {
                    t.classList.remove('active');
                });
                
                this.classList.add('active');
                
                const endpoint = this.getAttribute('data-endpoint');
                currentEndpoint = endpoint;
                searchInput.placeholder = placeholders[endpoint];
                
                if (searchInput.value.trim()) performSearch(searchInput.value, currentEndpoint);
            });
        });

        searchInput.addEventListener('input', function() {
            const query = searchInput.value;
            if (searchTimeout) clearTimeout(searchTimeout);
            
            if (!query.trim()) {
                clearSearch();
                return;
            }
            
            searchTabs.style.display = 'flex';
            cancelButton.style.display = 'flex';
            
            if (query.trim().length >= 2) {
                searchTimeout = setTimeout(() => {
                    performSearch(query, currentEndpoint);
                }, 150);
            }
        });

        searchInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                if (searchTimeout) clearTimeout(searchTimeout);
                performSearch(searchInput.value, currentEndpoint);
            }
        });

        window.clearSearch = clearSearch;
        window.performSearch = performSearch;
    });
</script>
