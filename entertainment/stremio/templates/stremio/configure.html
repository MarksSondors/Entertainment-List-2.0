{% extends 'components/base.html' %}
{% load static %}

{% block title %}Stremio Addon Configuration | Entertainment List{% endblock %}

{% block content %}
<div class="container py-4">
    <div class="profile-layout">
        <div class="main-content">
            <div class="window">
                <div class="title-bar">
                    <div class="title-bar-text">Stremio Addon - Configuration</div>
                    <div class="title-bar-controls">
                        <button aria-label="Minimize"></button>
                        <button aria-label="Maximize"></button>
                        <button aria-label="Close"></button>
                    </div>
                </div>
                <div class="window-body">
                    
                    <!-- Logo Section -->
                    <div style="text-align: center; margin-bottom: 20px;">
                        <img src="{% static 'images/logo.png' %}" alt="Entertainment List" style="width: 48px; height: auto; margin-bottom: 8px;">
                        <h3 style="margin: 0; font-size: 14px;">Entertainment List</h3>
                        <p style="margin: 4px 0 0 0; color: var(--text-muted);">Connect your watchlists to Stremio</p>
                    </div>
                    
                    <!-- API Key Input Section -->
                    <div class="field-row-stacked" style="margin-bottom: 15px;">
                        <h4><img src="{% static 'images/win98/certificate.png' %}" alt="" class="win98-icon"> API Key</h4>
                        <div class="sunken-panel" style="padding: 10px;">
                            <div class="field-row" style="margin-bottom: 10px;">
                                <input type="text" id="api_key" placeholder="Enter your API key" autocomplete="off" value="{{ api_key }}" style="width: 100%;">
                            </div>
                            <small style="display: block; margin-bottom: 10px; color: var(--text-muted);">
                                Find your API key in your <a href="/settings/">account settings</a>
                            </small>
                        </div>
                    </div>

                    <!-- Install Button Section -->
                    <div class="field-row-stacked" style="margin-bottom: 15px;">
                        <h4><img src="{% static 'images/win98/cd_audio.png' %}" alt="" class="win98-icon"> Installation</h4>
                        <div class="sunken-panel" style="padding: 10px;">
                            <div style="text-align: center; margin: 10px 0 15px 0;">
                                <a class="btn install-btn" id="installBtn" href="#" onclick="return installAddon()" style="font-size: 12px; padding: 8px 24px; text-decoration: none;">
                                    <img src="{% static 'images/win98/network_television.png' %}" alt="" class="win98-icon">
                                    Install Addon
                                </a>
                            </div>
                            
                            <div class="field-row button-row" style="justify-content: center;">
                                <button class="btn" id="copyBtn" onclick="copyUrl()">
                                    <img src="{% static 'images/win98/notepad_file.png' %}" alt="" class="win98-icon">
                                    Copy Manifest URL
                                </button>
                            </div>
                            
                            <div id="urlDisplay" style="display: none; margin-top: 15px;">
                                <label style="font-size: 10px; color: var(--text-muted);">Manifest URL:</label>
                                <input type="text" id="manifestUrlField" readonly onclick="this.select()" style="width: 100%; font-size: 10px; margin-top: 4px;">
                                <small style="display: block; margin-top: 8px; color: var(--text-muted);">
                                    Copy this URL and paste it in Stremio: Settings → Addons → Search box
                                </small>
                            </div>
                        </div>
                    </div>

                    <!-- Status Message -->
                    <div class="status-message" id="status" style="display: none;"></div>
                    
                    <!-- Features Section -->
                    <div class="field-row-stacked" style="margin-bottom: 15px;">
                        <h4><img src="{% static 'images/win98/star.png' %}" alt="" class="win98-icon"> What you'll get</h4>
                        <div class="sunken-panel" style="padding: 10px;">
                            <ul style="margin: 0; padding: 0 0 0 20px;">
                                <li style="margin-bottom: 6px;"><img src="{% static 'images/win98/camera_vid.png' %}" alt="" class="win98-icon"> Continue Watching - Shows you're currently watching</li>
                                <li style="margin-bottom: 6px;"><img src="{% static 'images/win98/favorites.png' %}" alt="" class="win98-icon"> Your movie watchlist in Stremio</li>
                                <li style="margin-bottom: 6px;"><img src="{% static 'images/win98/network_television.png' %}" alt="" class="win98-icon"> Your TV show watchlist in Stremio</li>
                                <li style="margin-bottom: 6px;"><img src="{% static 'images/win98/magnifying_glass.png' %}" alt="" class="win98-icon"> Personalized movie recommendations</li>
                                <li style="margin-bottom: 6px;"><img src="{% static 'images/win98/users.png' %}" alt="" class="win98-icon"> Movie of the Week picks you haven't seen</li>
                                <li style="margin-bottom: 6px;"><img src="{% static 'images/win98/star.png' %}" alt="" class="win98-icon"> Top rated movies you haven't seen</li>
                                <li style="margin-bottom: 0;"><img src="{% static 'images/win98/notepad_file.png' %}" alt="" class="win98-icon"> Your ratings displayed on movie details</li>
                            </ul>
                        </div>
                    </div>

                    <div class="field-row" style="justify-content: flex-start;">
                        <a href="/settings/" class="btn">← Back to Settings</a>
                    </div>
                </div>
                <div class="status-bar">
                    <div class="status-bar-field">Entertainment List Stremio Addon</div>
                    <div class="status-bar-field">Version 1.0.0</div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    .profile-layout {
        display: flex;
        justify-content: center;
    }
    
    .main-content {
        flex: 1;
        max-width: 600px;
    }

    .win98-icon {
        width: 16px;
        height: 16px;
        vertical-align: middle;
        margin-right: 4px;
    }

    .window-body {
        padding: 12px;
    }

    .sunken-panel {
        border: 2px solid;
        border-color: var(--win98-dark) var(--win98-light) var(--win98-light) var(--win98-dark);
        background-color: var(--win98-input-bg);
        padding: 8px;
        margin: 4px 0;
    }

    .status-bar {
        display: flex;
        justify-content: space-between;
        flex-wrap: wrap;
        border: 2px solid;
        border-color: var(--win98-dark) var(--win98-light) var(--win98-light) var(--win98-dark);
        border-top: none;
        padding: 2px 4px;
        background-color: var(--win98-gray);
        font-size: 11px;
        margin-top: 2px;
    }
    
    .status-bar-field {
        font-size: 11px;
        margin-right: 10px;
        border: 1px solid;
        border-color: var(--win98-dark) var(--win98-light) var(--win98-light) var(--win98-dark);
        padding: 0 4px;
        flex: 1;
    }

    .btn.disabled {
        opacity: 0.5;
        cursor: not-allowed;
        pointer-events: none;
    }

    .install-btn {
        background-color: #008080;
        color: #fff !important;
    }

    .install-btn:hover {
        background-color: #006666;
    }

    h3, h4 {
        font-weight: bold;
        margin: 0 0 8px 0;
    }

    h3 {
        font-size: 14px;
    }

    h4 {
        font-size: 11px;
    }

    .field-row {
        display: flex;
        align-items: center;
        margin-bottom: 8px;
    }

    .field-row.button-row {
        gap: 8px;
    }

    .field-row-stacked {
        display: block;
    }

    p, li {
        font-size: 11px;
        line-height: 1.5;
    }

    .status-message {
        padding: 8px 10px;
        margin-bottom: 15px;
        font-size: 11px;
        border: 2px solid;
    }

    .status-message.success {
        background-color: #d4edda;
        border-color: #155724;
        color: #155724;
    }

    .status-message.error {
        background-color: #f8d7da;
        border-color: #721c24;
        color: #721c24;
    }

    @media (max-width: 768px) {
        .profile-layout {
            flex-direction: column;
        }
        
        .main-content {
            flex: 1;
            width: 100%;
        }
        
        .container.py-4 {
            padding: 10px !important;
        }
        
        .field-row {
            flex-wrap: wrap;
            gap: 8px;
        }
        
        .sunken-panel {
            padding: 12px !important;
            margin-bottom: 15px !important;
        }
    }
</style>

<script>
        const BASE_URL = "{{ base_url }}";
        
        function encodeConfig(apiKey) {
            const config = JSON.stringify({ api_key: apiKey });
            // URL-safe base64 encoding
            return btoa(config)
                .replace(/\+/g, '-')
                .replace(/\//g, '_')
                .replace(/=+$/, '');
        }
        
        function getManifestUrl() {
            const apiKey = document.getElementById('api_key').value.trim();
            if (!apiKey) {
                return null;
            }
            
            const encodedConfig = encodeConfig(apiKey);
            return BASE_URL + encodedConfig + '/manifest.json';
        }
        
        function getStremioUrl() {
            const manifestUrl = getManifestUrl();
            if (!manifestUrl) return null;
            return manifestUrl.replace(/^https?:\/\//, 'stremio://');
        }
        
        function installAddon() {
            const apiKey = document.getElementById('api_key').value.trim();
            if (!apiKey) {
                showStatus('Please enter your API key', 'error');
                return false;
            }
            
            const stremioUrl = getStremioUrl();
            if (stremioUrl) {
                showStatus('Installing addon...', 'success');
                // The href is already set, just let the click through
                return true;
            }
            return false;
        }
        
        function copyUrl() {
            const manifestUrl = getManifestUrl();
            if (!manifestUrl) {
                showStatus('Please enter your API key', 'error');
                return;
            }
            
            navigator.clipboard.writeText(manifestUrl).then(() => {
                showStatus('Manifest URL copied! Paste it in Stremio: Settings → Addons → Search box', 'success');
            }).catch(() => {
                // Fallback for older browsers
                const input = document.createElement('input');
                input.value = manifestUrl;
                document.body.appendChild(input);
                input.select();
                document.execCommand('copy');
                document.body.removeChild(input);
                showStatus('Manifest URL copied! Paste it in Stremio: Settings → Addons → Search box', 'success');
            });
        }
        
        function showStatus(message, type) {
            const status = document.getElementById('status');
            status.textContent = message;
            status.className = 'status ' + type;
        }
        
        function updateInstallButton() {
            const apiKey = document.getElementById('api_key').value.trim();
            const installBtn = document.getElementById('installBtn');
            
            if (apiKey) {
                const stremioUrl = getStremioUrl();
                installBtn.href = stremioUrl;
                installBtn.classList.remove('disabled');
            } else {
                installBtn.href = '#';
                installBtn.classList.add('disabled');
            }
        }
        
        function updateUrlDisplay() {
            const apiKey = document.getElementById('api_key').value.trim();
            const urlDisplay = document.getElementById('urlDisplay');
            const urlField = document.getElementById('manifestUrlField');
            
            if (apiKey) {
                const url = getManifestUrl();
                if (url) {
                    urlField.value = url;
                    urlDisplay.style.display = 'block';
                }
            } else {
                urlDisplay.style.display = 'none';
            }
        }
        
        // Update on input
        document.getElementById('api_key').addEventListener('input', function() {
            updateInstallButton();
            updateUrlDisplay();
        });
        
        // Initial state
        updateInstallButton();
        
        // If API key is pre-filled, show URL and status
        const apiKeyInput = document.getElementById('api_key');
        if (apiKeyInput.value.trim()) {
            updateUrlDisplay();
            showStatus('API key loaded. Click Install to add the addon to Stremio.', 'success');
        }
    </script>
{% endblock %}
